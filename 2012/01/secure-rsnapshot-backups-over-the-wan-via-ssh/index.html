<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:og="http://ogp.me/ns#"
      xmlns:fb="https://www.facebook.com/2008/fbml">
<head>
    <title>Secure rsnapshot backups over the WAN via SSH</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Open Graph tags -->

    <!-- Bootstrap -->
        <link rel="stylesheet" href="http://blog.jasonantman.com/theme/css/bootstrap.flatly.min.css" type="text/css"/>
    <link href="http://blog.jasonantman.com/theme/css/font-awesome.min.css" rel="stylesheet">
    <link href="http://blog.jasonantman.com/theme/css/pygments.css" rel="stylesheet">
        <link href="http://blog.jasonantman.com/theme/css/typogrify.css" rel="stylesheet">
    <link rel="stylesheet" href="http://blog.jasonantman.com/theme/css/style.css" type="text/css"/>
    <!-- JavaScript plugins (requires jQuery) -->
    <script src="http://code.jquery.com/jquery.js"></script>

    <link rel="stylesheet" href="http://blog.jasonantman.com/theme/css/forkongithub.min.css" type="text/css" />

        <link href="http://blog.jasonantman.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Jason Antman's Blog ATOM Feed"/>
        <link href="http://blog.jasonantman.com/feeds/all.rss.xml" type="application/atom+xml" rel="alternate"
              title="Jason Antman's Blog RSS Feed"/>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-2718127-2', 'jasonantman.com');
  ga('send', 'pageview');

</script>
</head>
<body>
<span id="forkongithub"><a href="https://github.com/jantman/blog">Fork me on GitHub</a></span><nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://blog.jasonantman.com" class="navbar-brand">Jason Antman's Blog</a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="http://blog.jasonantman.com/pages/about.html">
                             About
                          </a></li>
                        <li >
                            <a href="http://blog.jasonantman.com/categories/ideas-and-rants/index.html">Ideas and rants</a>
                        </li>
                        <li >
                            <a href="http://blog.jasonantman.com/categories/miscellaneous/index.html">Miscellaneous</a>
                        </li>
                        <li >
                            <a href="http://blog.jasonantman.com/categories/monitoring/index.html">Monitoring</a>
                        </li>
                        <li >
                            <a href="http://blog.jasonantman.com/categories/ops/index.html">Ops</a>
                        </li>
                        <li >
                            <a href="http://blog.jasonantman.com/categories/projects/index.html">Projects</a>
                        </li>
                        <li >
                            <a href="http://blog.jasonantman.com/categories/puppet/index.html">Puppet</a>
                        </li>
                        <li class="active">
                            <a href="http://blog.jasonantman.com/categories/tech-howtos/index.html">Tech howtos</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a href="http://blog.jasonantman.com/archives.html"><i class="icon-th-list"></i>Archives</a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</nav>
<!-- /.navbar -->
<div class="container">
    <div class="row">
        <div class="col-lg-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="http://blog.jasonantman.com/2012/01/secure-rsnapshot-backups-over-the-wan-via-ssh/"
                       rel="bookmark"
                       title="Permalink to Secure rsnapshot backups over the WAN via SSH">
                        Secure rsnapshot backups over the <span class="caps">WAN</span> via&nbsp;<span class="caps">SSH</span>
                    </a>
                </h1>
<a href="http://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="j_antman">Tweet</a><script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="icon-calendar"></i>Sun 15 January 2012
    </span>



<span class="label label-default">Tags</span>
	<a href="http://blog.jasonantman.com/tags/backups/index.html">backups</a>
        /
	<a href="http://blog.jasonantman.com/tags/linode/index.html">linode</a>
        /
	<a href="http://blog.jasonantman.com/tags/rsnapshot/index.html">rsnapshot</a>
        /
	<a href="http://blog.jasonantman.com/tags/rsync/index.html">rsync</a>
        /
	<a href="http://blog.jasonantman.com/tags/security/index.html">security</a>
        /
	<a href="http://blog.jasonantman.com/tags/ssh/index.html">ssh</a>
        /
	<a href="http://blog.jasonantman.com/tags/wrapper/index.html">wrapper</a>
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>Since I moved all of my <span class="caps">WAN</span>-facing stuff (mail, web, this blog, svn
etc.) to a virtual server with <a href="http://www.linode.com">Linode</a>, and just
have a desktop at home, it&#8217;s no longer practical to use
<a href="http://www.bacula.org/">Bacula</a> for backups. Linode manages daily and
weekly backups through their backup service, but they&#8217;ll only restore a
full filesystem at a time. I wanted something that would keep daily and
weekly incremental backups long enough that I could find a file changed
(or accidentally deleted) a few days or weeks ago. Since I&#8217;d be backing
up to my desktop at home (which is on a residential dynamic <span class="caps">IP</span>
connection), the logical solution was something using
<a href="http://rsync.samba.org/">rsync</a>. Even better than that is the
<a href="http://rsnapshot.org/">rsnapshot</a> tool, which builds upon rsync and
hard links to manage incremental backups with as little disk usage as
possible (though I&#8217;d certainly recommend excluding log&nbsp;files).</p>
<p>I&#8217;m pretty strict about security. Since my home connection has a dynamic
<span class="caps">IP</span>, things are a bit more complicated - I can&#8217;t push from the server, I
can&#8217;t <span class="caps">ACL</span> or firewall the server to just my home <span class="caps">IP</span>, and an IPsec <span class="caps">VPN</span>
would be difficult to accomplish (not to mention add a lot of overhead
to big file transfers). So, I opted for a solution that uses <span class="caps">SSH</span>
key-based authentication, forced comands, and a C&nbsp;wrapper.</p>
<p>The configuration of rsync and rsnapshot is mostly out of the scope of
this post. There are plenty of good resources for that, so I&#8217;ll just
cover the things that won&#8217;t be found in most tutorials. Also, I&#8217;ll be
referring to the remote machine to be backed up as the &#8220;remote host&#8221; and
the local machine which triggers the backup and stores the data as the
&#8220;local&nbsp;host&#8221;.</p>
<h2 id="local-host-setup-part-i">Local Host Setup - Part&nbsp;I</h2>
<ol>
<li>Choose and create a directory to store your backups in. I have a <span class="caps">1TB</span>
    external disk mounted at <code>/mnt/backup/</code>, so I chose
    <code>/mnt/backup/rsnapshot/</code>.</li>
<li>Generate two sets of password-less <span class="caps">SSH</span> keys using the <code>ssh-keygen</code>
    program. One will be used to run the rsync command on the remote
    host, the other will be used to trigger your pre- and post-backup
    scripts. Name them accordingly (i.e.
    &#8220;remoteHostname_remoteBackupUsername_cmd&#8221; and
    &#8220;remoteHostname_remoteBackupUsername_rsync&#8221;). Now, get (scp) the
    public key for each pair to the remote&nbsp;host.</li>
</ol>
<h2 id="remote-host-setup">Remote Host&nbsp;Setup</h2>
<ol>
<li>Ensure that rsync is installed on the&nbsp;host.</li>
<li>Create a user to run the backups. I called this user &#8220;rsyncuser&#8221;.
    Create a home directory, and a group for the user. Do not set a
    password (you don&#8217;t want password&nbsp;logins).</li>
<li>Copy the public key files you created above to the user&#8217;s <code>~/.ssh/</code>
    directory.</li>
<li>Cat the &#8220;remoteHostname_remoteBackupUsername_cmd&#8221; public key into
    the user&#8217;s <code>~/.ssh/authorized_keys</code> file.</li>
<li>Now comes the first fun part. Let&#8217;s assume that your pre- and
    post-backup scripts are <code>/root/bin/rsnapshot-pre.sh</code> and
    <code>/root/bin/rsnapshot-post.sh</code>, respectively. As root, grab a copy of
    cmd-wrapper.c (from
    <a href="https://github.com/jantman/misc-scripts/blob/master/cmd-wrapper.c">GitHub</a>
    or at the bottom of this post). Modify for your use - the only thing
    likely to change is line 38, which ensures it will only run for a
    member of <span class="caps">GID</span> 502. Change this to rsyncuser&#8217;s <span class="caps">GID</span>. Compile the
    wrapper with <code>gcc -o cmd-wrapper cmd-wrapper.c</code>. Copy it to
    rsyncuser&#8217;s home directory (/home/rsyncuser), <code>chown root:rsyncuser</code>
    and <code>chmod 4750</code>. Yes, this sets the <span class="caps">SUID</span> bit. The program will now
    be owned by root, and runnable <em>as root</em> by rsyncuser (or, more
    specifically, any member of the rsyncuser&nbsp;group).</li>
<li>Open rsyncuser&#8217;s <code>.ssh/authorized_keys</code> file in a text editor. At
    the beginning of the &#8220;remoteHostname_remoteBackupUsername_cmd&#8221; key
    line, prepend <code>command="/home/rsyncuser/cmd-wrapper"</code>. This sets up
    <span class="caps">SSH</span> forced command (there&#8217;s a good overview in <a href="http://oreilly.com/catalog/sshtdg/chapter/ch08.html">O&#8217;Reilly&#8217;s <span class="caps">SSH</span>: The
    Definitive
    Guide</a>) so that
    when this key is used to login, it will directly execute
    <code>/home/rsyncuser/cmd-wrapper</code> and then exit, without allowing access
    to anything&nbsp;else.</li>
<li>Add rsyncuser to <code>AllowUsers</code> in <code>/etc/ssh/sshd_config</code> (you <em>do</em>
    limit user access via <span class="caps">SSH</span>, right?) and then reload&nbsp;sshd.</li>
<li>Now, if you <span class="caps">SSH</span> to rsyncuser@remoteHost from the local host, using
    the &#8220;_cmd&#8221; ssh key and a command of &#8220;pre&#8221; (i.e.
    <code>ssh -i /path/to/remoteHostname_remoteBackupUsername_cmd rsyncuser@remoteHost pre</code>),
    it should execute <code>/root/bin/rsnapshot-pre.sh</code> ad root, and you
    should see the output&nbsp;locally.</li>
<li>Repeat the above step for the post-backup script (replacing &#8220;pre&#8221;
    above with &#8220;post&#8221;). You should now have your pre- and post-backup
    scripts working, and triggered remotely. <em>(Note: these steps, and
    some of the other setup here, is a bit more complex so that it will
    work better with rsnapshot backups of multiple remote&nbsp;hosts.)</em></li>
<li>Cat the &#8220;remoteHostname_remoteBackupUsername_rsync&#8221; public key
    into the backup user&#8217;s <code>~/.ssh/authorized_keys</code> file.</li>
<li>As root, grab a copy of rsync-wrapper.c (from
    <a href="https://github.com/jantman/misc-scripts/blob/master/rsync-wrapper.c">GitHub</a>
    or at the bottom of this post). Modify for your use - the only thing
    likely to change is line 38, which ensures it will only run for a
    member of <span class="caps">GID</span> 502 (change this to rsyncuser&#8217;s <span class="caps">GID</span>), and perhaps the
    path of or arguments passed to rsync (the wrapper will call
    <code>/usr/bin/rsync --server --sender -vlogDtprRe.iLsf --numeric-ids . /</code>).
    Compile the wrapper with <code>gcc -o rsync-wrapper rsync-wrapper.c</code>.
    Copy it to rsyncuser&#8217;s home directory (/home/rsyncuser),
    <code>chown root:rsyncuser</code> and <code>chmod 4750</code>.</li>
<li>Open rsyncuser&#8217;s <code>.ssh/authorized_keys</code> file in a text editor. At
    the beginning of the &#8220;remoteHostname_remoteBackupUsername_rsync&#8221;
    key line, prepend <code>command="/home/rsyncuser/rsync-wrapper"</code>. This
    will run rsync with the arguments specified in rsync-wrapper.c every
    time this key is used to&nbsp;login.</li>
</ol>
<h2 id="local-host-setup-part-ii">Local Host Setup - Part&nbsp;<span class="caps">II</span></h2>
<p>I use totally separate configs for each host that I backup, to keep
things clean and to let me enable, disable, or tweak one remote backup
without affecting the&nbsp;others.</p>
<ol>
<li>
<p>Create host-specific pre- and post-backup scripts. I put them in
    <code>/etc/rsnapshot.d/</code>.
    <code>/etc/rsnapshot.d/pre-remoteHostName.sh</code>:</p>
<div class="codehilite"><pre><span class="c">#!/bin/bash</span>

<span class="c"># do anything else needed on the local system before a backup</span>
ssh -i /path/to/remoteHostname_remoteBackupUsername_cmd rsyncuser@remoteHost pre
</pre></div>


<p><code>/etc/rsnapshot.d/post-remoteHostName.sh</code>:</p>
<div class="codehilite"><pre><span class="c">#!/bin/bash</span>

<span class="c"># do anything else needed on the local system after a backup</span>
ssh -i /path/to/remoteHostname_remoteBackupUsername_cmd rsyncuser@remoteHost post
</pre></div>


</li>
<li>
<p>Setup a set of rsync include and exclude files (see <code>man rsync(1)</code>,
    <code>--include-from=</code> and <code>--exclude-from=</code>). I put mine at
    <code>/etc/rsnapshot.d/rsync-include-remoteHostName.txt</code> and
    <code>/etc/rsnapshot.d/rsync-exclude-remoteHostName.txt</code>, respectively.
    (Examples included at the bottom of this&nbsp;post).</p>
</li>
<li>
<p>Configure rsnapshot. I use a separate config file for each remote
    host. Copy the default <code>/etc/rsnapshot.conf</code> to
    <code>/etc/rsnapshot-remoteHostName.conf</code>. The important items are
    <code>rsync_short_args</code>, <code>rsync_long_args</code>, <code>ssh_args</code>, <code>cmd_preexec</code>,
    <code>cmd_postexec</code> and <code>backup</code>. Here&#8217;s an example of my config file,
    with comments and blank lines&nbsp;removed:</p>
<div class="codehilite"><pre>config_version  1.2
snapshot_root   /mnt/backup/rsnapshot/
cmd_cp          /bin/cp
cmd_rm          /bin/rm
cmd_rsync       /usr/bin/rsync
cmd_ssh         /usr/bin/ssh
cmd_logger      /bin/logger
cmd_du          /usr/bin/du
cmd_rsnapshot_diff      /usr/bin/rsnapshot-diff
interval        daily   14 # save 14 daily backups
interval        weekly  6 # save 6 weekly backups
verbose         2
loglevel        3
logfile /var/log/rsnapshot-remoteHostName.log
lockfile        /var/run/rsnapshot-remoteHostName.pid
rsync_short_args        -a
rsync_long_args --delete --numeric-ids --relative --delete-excluded
ssh_args        -i /path/to/remoteHostname_remoteBackupUsername_rsync
exclude_file    /etc/rsnapshot.d/rsync-exclude-remoteHostName.txt
include_file    /etc/rsnapshot.d/rsync-include-remoteHostName.txt
link_dest       1
use_lazy_deletes        1
cmd_preexec     /etc/rsnapshot.d/pre-remoteHostName.sh
cmd_postexec    /etc/rsnapshot.d/post-remoteHostName.sh
backup  rsyncuser@remoteHostName:/      remoteHostName/
</pre></div>


<p>The <code>backup</code> line is what tells rsync what to back up (<code>/</code> on
remoteHostName, logging in as rsyncuser), and where to back up to&nbsp;(snapshot_root/remoteHostName/).</p>
</li>
<li>
<p>Create two scripts that will actually trigger the backups, which
    I&#8217;ll call <code>/root/bin/rsnapshot-daily.sh</code> and <code>/root/bin/rsnapshot-weekly.sh</code>:</p>
<p><code>/root/bin/rsnapshot-daily.sh</code>:</p>
<div class="codehilite"><pre><span class="c">#!/bin/bash</span>

/usr/bin/rsnapshot -c /etc/rsnapshot-remoteHostName.conf daily
<span class="c"># add other hosts here; note, they&#39;ll run in series</span>
</pre></div>


<p><code>/root/bin/rsnapshot-weekly.sh</code>:</p>
<div class="codehilite"><pre><span class="c">#!/bin/bash</span>

/usr/bin/rsnapshot -c /etc/rsnapshot-remoteHostName.conf weekly
<span class="c"># add other hosts here; note, they&#39;ll run in series</span>
</pre></div>


</li>
<li>
<p>Add two entries to root&#8217;s croontab to run the rsnapshot backups.
    Adjust the following days and times to your&nbsp;liking:</p>
<div class="codehilite"><pre>0 1 * * Mon /root/bin/rsnapshot-weekly.sh # run the weekly backups every Monday at 01:00
30 2 * * * /root/bin/rsnapshot-daily.sh # run the daily backups every day at 02:30, which *should* be after the weekly finished on Monday morning
</pre></div>


</li>
<li>
<p>Check, after the next scheduled runs, that everything appears to
    have run correctly. If you want, you can manually trigger the daily
    script and watch what happens. If you do this more than once, you
    should delete the directories it creates, or else rotation will be
    messed up. If you have issues with rsync, aside from the usual
    troubleshooting, check that rsync-wrapper.c is calling rsync with
    the same arguments that rsnapshot is sending. It may be useful to
    use my
    <a href="https://github.com/jantman/misc-scripts/blob/master/print-cmd.sh">print-cmd.sh</a>
    script in place of the &#8220;rsync-wrapper&#8221; forced command. This script
    will simply log the command rsnapshot calls via&nbsp;<span class="caps">SSH</span>.</p>
</li>
</ol>
<p>Assuming all of this worked, you should now have a fairly secure
<span class="caps">SSH</span>-based remotely-triggered backup system. In a follow-up post I
provide my <a href="/2012/02/nagios-check-plugin-for-rsnapshot-backups/">Nagios Check Plugin for Rsnapshot
Backups</a>.</p>
<p>The referenced scripts, config files, etc. are&nbsp;below:</p>
<p><code>cmd-wrapper.c</code>:</p>
<div class="codehilite"><pre><span class="cp">#include </span>
<span class="cp">#include </span>
<span class="cp">#include </span>
<span class="cp">#include </span>
<span class="cp">#include </span>
<span class="cp">#include </span>

<span class="cm">/********************************************</span>
<span class="cm"> * Wrapper - Secure Yourself                </span>
<span class="cm"> *                                          </span>
<span class="cm"> * 2007 - Mike Golvach - eggi@comcast.net   </span>
<span class="cm"> * Modified 2012 by Jason Antman  </span>
<span class="cm"> *  - configured for use as pre- and post-backup script wrapper</span>
<span class="cm"> *                                          </span>
<span class="cm"> * <span class="caps">USAGE</span>: cmd-wrapper [pre|post]</span>
<span class="cm"> *</span>
<span class="cm"> * $HeadURL: http://svn.jasonantman.com/misc-scripts/cmd-wrapper.c $</span>
<span class="cm"> * $LastChangedRevision: 26 $</span>
<span class="cm"> *                                          </span>
<span class="cm"> ********************************************/</span>

<span class="cm">/* Creative Commons Attribution-Noncommercial-Share Alike 3.0 United States License */</span>

<span class="cm">/* Define global variables */</span>

<span class="kt">int</span> <span class="n">gid</span><span class="p">;</span>

<span class="cm">/* main(int argc, char **argv) - main process loop */</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">origcmd</span><span class="p">;</span>

  <span class="n">origcmd</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="s">&quot;SSH_ORIGINAL_COMMAND&quot;</span><span class="p">);</span>

  <span class="cm">/* printf (&quot;Original Command:%s\n&quot;, origcmd); */</span>

  <span class="cm">/* Set euid and egid to actual user */</span>

  <span class="n">gid</span> <span class="o">=</span> <span class="n">getgid</span><span class="p">();</span>
  <span class="n">setegid</span><span class="p">(</span><span class="n">getgid</span><span class="p">());</span>
  <span class="n">seteuid</span><span class="p">(</span><span class="n">getuid</span><span class="p">());</span>

  <span class="cm">/* Confirm user is in <span class="caps">GROUP</span>(502) group */</span>

  <span class="k">if</span> <span class="p">(</span> <span class="n">gid</span> <span class="o">!=</span> <span class="mi">502</span> <span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;User Not Authorized! Exiting...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/* Check argc count only at this point */</span>

  <span class="k">if</span> <span class="p">(</span> <span class="n">argc</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Usage: cmd-wrapper [pre|post]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/* Set uid, gid, euid and egid to root */</span>

  <span class="n">setegid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="n">seteuid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="n">setgid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="n">setuid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

  <span class="cm">/* Check argv for proper arguments and run</span>
<span class="cm">   * the corresponding script, if invoked.</span>
<span class="cm">   */</span>

  <span class="k">if</span> <span class="p">(</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">origcmd</span><span class="p">,</span> <span class="s">&quot;pre&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">execl</span><span class="p">(</span><span class="s">&quot;/root/bin/rsnapshot-pre.sh&quot;</span><span class="p">,</span> <span class="s">&quot;rsnapshot-pre.sh&quot;</span><span class="p">,</span> <span class="nb"><span class="caps">NULL</span></span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">perror</span><span class="p">(</span><span class="s">&quot;Execl:&quot;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">origcmd</span><span class="p">,</span> <span class="s">&quot;post&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">execl</span><span class="p">(</span><span class="s">&quot;/root/bin/rsnapshot-post.sh&quot;</span><span class="p">,</span> <span class="s">&quot;rsnapshot-post.sh&quot;</span><span class="p">,</span> <span class="nb"><span class="caps">NULL</span></span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">perror</span><span class="p">(</span><span class="s">&quot;Execl:&quot;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;<span class="caps">ERROR</span>: Invalid command: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">origcmd</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Usage: <span class="caps">COMMAND</span> [pre|post]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<p><code>rsync-wrapper.c</code>:</p>
<div class="codehilite"><pre><span class="cp">#include </span>
<span class="cp">#include </span>
<span class="cp">#include </span>
<span class="cp">#include </span>
<span class="cp">#include </span>

<span class="cm">/********************************************</span>
<span class="cm"> * Wrapper - Secure Yourself                </span>
<span class="cm"> *                                          </span>
<span class="cm"> * 2007 - Mike Golvach - eggi@comcast.net   </span>
<span class="cm"> * Modified 2012 by Jason Antman  </span>
<span class="cm"> *  - configured for use as rsync wrapper</span>
<span class="cm"> *                                          </span>
<span class="cm"> * $HeadURL: http://svn.jasonantman.com/misc-scripts/rsync-wrapper.c $</span>
<span class="cm"> * $LastChangedRevision: 26 $</span>
<span class="cm"> *                                          </span>
<span class="cm"> ********************************************/</span>

<span class="cm">/* Creative Commons Attribution-Noncommercial-Share Alike 3.0 United States License */</span>

<span class="cm">/* Define global variables */</span>

<span class="kt">int</span> <span class="n">gid</span><span class="p">;</span>

<span class="cm">/* main(int argc, char **argv) - main process loop */</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>

  <span class="cm">/* Set euid and egid to actual user */</span>

  <span class="n">gid</span> <span class="o">=</span> <span class="n">getgid</span><span class="p">();</span>
  <span class="n">setegid</span><span class="p">(</span><span class="n">getgid</span><span class="p">());</span>
  <span class="n">seteuid</span><span class="p">(</span><span class="n">getuid</span><span class="p">());</span>

  <span class="cm">/* Confirm user is in <span class="caps">GROUP</span>(502) group */</span>

  <span class="k">if</span> <span class="p">(</span> <span class="n">gid</span> <span class="o">!=</span> <span class="mi">502</span> <span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;User Not Authorized! Exiting...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/* Check argc count only at this point */</span>

  <span class="k">if</span> <span class="p">(</span> <span class="n">argc</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Usage: rsync-wrapper</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/* Set uid, gid, euid and egid to root */</span>

  <span class="n">setegid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="n">seteuid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="n">setgid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="n">setuid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

  <span class="cm">/* Check argv for proper arguments and run</span>
<span class="cm">   * the corresponding script, if invoked.</span>
<span class="cm">   */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">execl</span><span class="p">(</span><span class="s">&quot;/usr/bin/rsync&quot;</span><span class="p">,</span> <span class="s">&quot;rsync&quot;</span><span class="p">,</span> <span class="s">&quot;--server&quot;</span><span class="p">,</span> <span class="s">&quot;--sender&quot;</span><span class="p">,</span> <span class="s">&quot;-vlogDtprRe.iLsf&quot;</span><span class="p">,</span> <span class="s">&quot;--numeric-ids&quot;</span><span class="p">,</span> <span class="s">&quot;.&quot;</span><span class="p">,</span> <span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="nb"><span class="caps">NULL</span></span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">perror</span><span class="p">(</span><span class="s">&quot;Execl:&quot;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<p><code>/etc/rsnapshot.d/rsync-include-remoteHostName.txt</code>:</p>
<div class="codehilite"><pre># Include
+ /dev/console
+ /dev/initctl
+ /dev/null
+ /dev/zero
+ /usr/local/*
</pre></div>


<p><code>/etc/rsnapshot.d/rsync-exclude-remoteHostName.txt</code>:</p>
<div class="codehilite"><pre># Exclude
- /cgroup/*
- /dev/*
- /lib/*
- lost+found/
- /proc/*
- /sys/
- /tmp/
- /var/log/*
</pre></div>
            </div>
            <!-- /.entry-content -->
    <hr />
    <section class="comments" id="comments">
        <h2>Comments</h2>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'jantman'; // required: replace example with your forum shortname
            var disqus_identifier = 'secure-rsnapshot-backups-over-the-wan-via-ssh';
            var disqus_url = 'http://blog.jasonantman.com/2012/01/secure-rsnapshot-backups-over-the-wan-via-ssh/';

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-lg-3 well well-sm" id="sidebar">

<aside>
    <section>
        <ul class="list-group list-group-flush">

                <li class="list-group-item"><h4><i class="icon-home icon-large"></i>Recent Posts</h4></li>
                        <li class="list-group-item">
                            <a href="http://blog.jasonantman.com/2016/04/terraform-shortcomings-no-interpolated-default-values-no-functions/">
                                Terraform Shortcomings - No Interpolated Default Values, No Functions, No Conditionals, Local State&nbsp;Storage
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="http://blog.jasonantman.com/2016/01/raspberry-pi-security-system/">
                                Raspberry Pi Security&nbsp;System
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="http://blog.jasonantman.com/2015/10/a-rant-on-post-secondary-tech-education/">
                                A Rant on Post-Secondary Tech&nbsp;Education
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="http://blog.jasonantman.com/2015/09/puppetlabs-beaker-suts-with-gui--non-headless/">
                                Puppetlabs Beaker SUTs with <span class="caps">GUI</span> /&nbsp;Non-Headless
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="http://blog.jasonantman.com/2015/07/awslimitchecker-check-your-aws-usage-against-service-limits/">
                                AwsLimitChecker - Check Your <span class="caps">AWS</span> Usage Against Service&nbsp;Limits
                            </a>
                        </li>


                <li class="list-group-item"><a href="http://blog.jasonantman.com/tags.html"><h4><i class="icon-tags icon-large"></i>Tags</h4></a></li>
                <li class="list-group-item">
                        <span class="tag-1">
                            <a href="http://blog.jasonantman.com/tags/microsoft/index.html">
                                microsoft
                            </a>
                        </span>
                        <span class="tag-1">
                            <a href="http://blog.jasonantman.com/tags/monitoring/index.html">
                                monitoring
                            </a>
                        </span>
                        <span class="tag-1">
                            <a href="http://blog.jasonantman.com/tags/sun/index.html">
                                sun
                            </a>
                        </span>
                        <span class="tag-1">
                            <a href="http://blog.jasonantman.com/tags/nagios/index.html">
                                Nagios
                            </a>
                        </span>
                        <span class="tag-1">
                            <a href="http://blog.jasonantman.com/tags/blog/index.html">
                                blog
                            </a>
                        </span>
                        <span class="tag-1">
                            <a href="http://blog.jasonantman.com/tags/wordpress/index.html">
                                wordpress
                            </a>
                        </span>
                        <span class="tag-1">
                            <a href="http://blog.jasonantman.com/tags/puppet/index.html">
                                puppet
                            </a>
                        </span>
                        <span class="tag-1">
                            <a href="http://blog.jasonantman.com/tags/android/index.html">
                                android
                            </a>
                        </span>
                        <span class="tag-1">
                            <a href="http://blog.jasonantman.com/tags/php/index.html">
                                PHP
                            </a>
                        </span>
                        <span class="tag-1">
                            <a href="http://blog.jasonantman.com/tags/sysadmin/index.html">
                                sysadmin
                            </a>
                        </span>
                        <span class="tag-1">
                            <a href="http://blog.jasonantman.com/tags/security/index.html">
                                security
                            </a>
                        </span>
                        <span class="tag-1">
                            <a href="http://blog.jasonantman.com/tags/linux/index.html">
                                linux
                            </a>
                        </span>
                        <span class="tag-1">
                            <a href="http://blog.jasonantman.com/tags/google/index.html">
                                google
                            </a>
                        </span>
                        <span class="tag-2">
                            <a href="http://blog.jasonantman.com/tags/python/index.html">
                                python
                            </a>
                        </span>
                        <span class="tag-2">
                            <a href="http://blog.jasonantman.com/tags/droid/index.html">
                                droid
                            </a>
                        </span>
                        <span class="tag-2">
                            <a href="http://blog.jasonantman.com/tags/syslog/index.html">
                                syslog
                            </a>
                        </span>
                        <span class="tag-2">
                            <a href="http://blog.jasonantman.com/tags/apache/index.html">
                                apache
                            </a>
                        </span>
                        <span class="tag-2">
                            <a href="http://blog.jasonantman.com/tags/dns/index.html">
                                dns
                            </a>
                        </span>
                        <span class="tag-2">
                            <a href="http://blog.jasonantman.com/tags/rpm/index.html">
                                rpm
                            </a>
                        </span>
                        <span class="tag-2">
                            <a href="http://blog.jasonantman.com/tags/firefox/index.html">
                                firefox
                            </a>
                        </span>
                </li>
        </ul>
    </section>
    <section>
    <ul class="list-group list-group-flush">
    <li class="list-group-item" style="padding: 10px 15px 0px 15px;"><h4><i class="icon-twitter
    icon-large"></i>Twitter <a href="https://twitter.com/j_antman"
    class="twitter-follow-button" data-show-count="false"
    data-dnt="true">Follow @j_antman</a></h4>
<script>!function(d,s,id){var
  js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document,
  'script', 'twitter-wjs');</script></li>
    </ul>
    <a class="twitter-timeline" data-dnt="true"
    href="https://twitter.com/j_antman"
    data-chrome="transparent noheader" data-widget-id="429640274453594113">Tweets by @j_antman</a>
    <script>!function(d,s,id){var
    js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
    </section>
    <section>
    <ul class="list-group list-group-flush">
    <li class="list-group-item"><h4><i class="icon-github icon-large"></i>GitHub Repos</h4></li>
        <div id="gh_repos">
            <p class="list-group-item">Status updating...</p>
        </div>
            <a href="https://github.com/jantman">@jantman</a> on GitHub
    </ul>
        <script type="text/javascript">
            $(document).ready(function () {
                if (!window.jXHR) {
                    var jxhr = document.createElement('script');
                    jxhr.type = 'text/javascript';
                    jxhr.src = 'http://blog.jasonantman.com/theme/js/jXHR.js';
                    var s = document.getElementsByTagName('script')[0];
                    s.parentNode.insertBefore(jxhr, s);
                }

                github.showRepos({
                    user: 'jantman',
                    count: 5,
                    skip_forks: false,
                    target: '#gh_repos'
                });
            });
        </script>
        <script src="http://blog.jasonantman.com/theme/js/github.js" type="text/javascript"></script>
    </section>
</aside>        </div>
    </div>
</div>
<footer>
    <div class="container">
        <hr>
        <p class="pull-right"><i class="icon-arrow-up"></i> <a href="#">Back to top</a></p>


        <p>&copy; 2016 Jason Antman &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a></p>
    </div>
</footer>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="http://blog.jasonantman.com/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="http://blog.jasonantman.com/theme/js/respond.min.js"></script>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'jantman'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>


</body>
</html>