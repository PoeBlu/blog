<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
>
<head>
    <title>Puppet3 rollout project for a large web shop</title>
    <!-- Using the latest rendering mode for IE -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Open Graph tags -->
    <!-- Bootstrap -->
        <link rel="stylesheet" href="http://jantman.github.io/blog/theme/css/bootstrap.flatly.min.css" type="text/css"/>
    <link href="http://jantman.github.io/blog/theme/css/font-awesome.min.css" rel="stylesheet">
    <link href="http://jantman.github.io/blog/theme/css/pygments.css" rel="stylesheet">
        <link href="http://jantman.github.io/blog/theme/css/typogrify.css" rel="stylesheet">
    <link rel="stylesheet" href="http://jantman.github.io/blog/theme/css/style.css" type="text/css"/>
    <!-- JavaScript plugins (requires jQuery) -->
    <script src="http://code.jquery.com/jquery.js"></script>

    <link rel="stylesheet" href="http://jantman.github.io/blog/theme/css/forkongithub.min.css" type="text/css" />


</head>
<body>
<span id="forkongithub"><a href="https://github.com/jantman/blog">Fork me on GitHub</a></span><nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://jantman.github.io/blog" class="navbar-brand">Jason Antman's Blog</a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="http://jantman.github.io/blog/pages/about.html">
                             About
                          </a></li>
                        <li >
                            <a href="http://jantman.github.io/blog/category/ideas-and-rants.html">Ideas and rants</a>
                        </li>
                        <li >
                            <a href="http://jantman.github.io/blog/category/miscellaneous.html">Miscellaneous</a>
                        </li>
                        <li >
                            <a href="http://jantman.github.io/blog/category/monitoring.html">Monitoring</a>
                        </li>
                        <li >
                            <a href="http://jantman.github.io/blog/category/projects.html">Projects</a>
                        </li>
                        <li class="active">
                            <a href="http://jantman.github.io/blog/category/puppet.html">Puppet</a>
                        </li>
                        <li >
                            <a href="http://jantman.github.io/blog/category/sysadmin.html">Sysadmin</a>
                        </li>
                        <li >
                            <a href="http://jantman.github.io/blog/category/tech-howtos.html">Tech howtos</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a href="http://jantman.github.io/blog/archives.html"><i class="icon-th-list"></i>Archives</a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</nav>
<!-- /.navbar -->
<div class="container">
    <div class="row">
        <div class="col-lg-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="http://jantman.github.io/blog/2013/10/puppet3-rollout-project-for-a-large-web-shop/"
                       rel="bookmark"
                       title="Permalink to Puppet3 rollout project for a large web shop">
                        Puppet3 rollout project for a large web&nbsp;shop
                    </a>
                </h1>
<a href="http://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="j_antman">Tweet</a><script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="icon-calendar"></i>Fri 25 October 2013
    </span>



<span class="label label-default">Tags</span>
	<a href="http://jantman.github.io/blog/tag/puppet.html">puppet</a>
        /
	<a href="http://jantman.github.io/blog/tag/puppet3.html">puppet3</a>
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>We&#8217;ve got a pretty sizable Puppet infrastructure at work, spanning about
240 nodes - currently a mix of Puppet Enterprise 2.5.0 on the production
and <span class="caps">QA</span> machines, and Puppet Open Source on many of the development and
testing boxes. We run the web presence and some associated services for
a bunch (about 150 or so) of large media properties (newspapers, <span class="caps">TV</span> and
radio stations), on an all-CentOS Linux infrastructure. Having gotten a
break in my time-sensitive work - I&#8217;ve got 2-3 weeks from when I
finished my last customer-visible project until the next dozen machines
get racked to build out a paid of new <span class="caps">QA</span> environments - I&#8217;m finally able
to move forward with our Puppet3 rollout, albeit at a breakneck&nbsp;pace.</p>
<p>I spent a few days diving into the current best practices, how others
are doing Puppet these days (especially <a href="https://github.com/puppetlabs-operations">Puppet Labs&#8217; own Operations
team</a> and <a href="https://wiki.mozilla.org/ReleaseEngineering/PuppetAgain">Mozilla Release
Engineering</a>),
and the great <a href="http://www.slideshare.net/search/slideshow?searchfrom=header&amp;q=%22puppetconf+2013%22">side
decks</a>
and <a href="http://www.youtube.com/playlist?list=PLV86BgbREluU02Ytlz80seDSKAbkx5pRg">recently released
videos</a>
from PuppetConf 2013. Then I cut 31 tickets and started working through&nbsp;them&#8230;</p>
<p>In this first of a series of posts, I&#8217;ll describe the current state of
our puppet infrastructure, and our plans for the Puppet3 rollout (which
we&#8217;ll handle in two phases). I plan on following this up with a series
of detailed posts on how we&#8217;re implementing Puppet3, and hopefully
sharing some of the code I wrote (though some of it is admittedly&nbsp;environment-specific).</p>
<h2 id="the-current-state-of-our-puppet">The Current State of Our&nbsp;Puppet</h2>
<p>Put simply, our current Puppet environment is pretty poor. I&#8217;d say it&#8217;s
typical of a grassroots, organic Puppet deployment (granted it&#8217;s our
second, started in March 2011; and there are some hosts that never made
it into &#8220;2.0&#8221;, still running 0.25.5 pointing to a nonexistent master).
We&#8217;re currently running Puppet Enterprise 2.5.0 on almost all nodes,
pointing to a single production <span class="caps">PE</span> 2.5.0 master. Development/testing
nodes generally run 2.6.x Open Source, pointing at a single Open Source
&#8220;testing&#8221; master, which runs per-user puppet environments, manually
managed as clones of our single puppet git repo. All hosts have the
awful <code>$ssldir = $confdir/$server</code> hack for doing one-off testing runs
against the test&nbsp;puppetmaster.</p>
<p>We keep everything in one git repo, and currently have community
(forge/github) modules intermixed with our own, and some of them are
locally modified. The only &#8220;management&#8221; is a <span class="caps">README</span>.md file that lists
the source of each module, the version it was at when we downloaded the
tarball, and whether or not it has local changes. &#8220;Testing&#8221; is checking
out a feature branch to a per-user environment on the test puppetmaster,
and doing a one-time noop run of a suitable host against the test
puppetmaster, usually followed by a one-time agent run, after which we
do peer code review and then merge to the master branch in git, and
manually deploy master on the production puppetmaster. There&#8217;s no
automated testing at all, and the whole procedure is manual (and done as&nbsp;root).</p>
<p>Due to past disasters, Puppet agents are disabled on all production
hosts; Puppet is used to build out the host, and then <code>--disable</code>ed and
stopped. As a result, configuration state of the production environment
is dictated by the state of modules at the time a given host was built,
and has diverged widely between hosts. Non-production (development,
testing, <span class="caps">QA</span>, etc.) environments are slightly better, but have a handful
of modules that are out of date and constantly fail (causing runs on
approximately 20% of hosts, mainly our development environments, to show
as&nbsp;failed).</p>
<p>We currently use a directory full of modules, mainly homegrown, and
Puppet Enterprise Console (i.e. Puppet Dashboard) for report
storage/display and as an <span class="caps">ENC</span>. The <span class="caps">ENC</span> features of Dashboard don&#8217;t come
close to meeting our needs; mainly the lack of support for parameterized
classes, the lack of a complete and detailed audit trail, the lack of
support for structured data (i.e. arrays and lists coming from the <span class="caps">ENC</span>),
the lack of ACLs or some sort of way to give a set of users access to
only certain nodes, and the inability to safely override or exclude
classes/parameters inherited from a&nbsp;group.</p>
<p>Currently, only our operations and automation teams have privileges to
push to the puppet repository, mainly because of the manual testing
requirements. We need to be able to allow developers access to puppet in
the same way that we have it, rather than requiring ops to manually push
and&nbsp;test.</p>
<h2 id="plans-for-our-puppet3-infrastructure">Plans for Our Puppet3&nbsp;Infrastructure</h2>
<p>Our plan is to move to Puppet3 and some current best practices around
testing and workflow, in two phases. The first phase will include the
buildout of the infrastructure and some minimal automated testing
(static testing and confirmation of successful runs), as well as
migration of existing hosts to the new puppet versions and masters.
Phase Two will include automated <span class="caps">VM</span>-based testing. If you&#8217;re interested,
you can see my (slightly modified) elaboration meeting slides for the
<a href="https://docs.google.com/presentation/d/1U36N6la82nIPTDrgkKn9A8BpZ50Y5wb_rgJ-j26ahDM/pub?start=false&amp;loop=false&amp;delayms=30000">infrastructure portion on Google
Docs</a>
and the <a href="http://blog.jasonantman.com/GFX/puppet_workflow.html">workflow portion as deck.js
slides</a>.</p>
            </div>
            <!-- /.entry-content -->
        </article>
    </section>

        </div>
        <div class="col-lg-3 well well-sm" id="sidebar">

<aside>
    <section>
        <ul class="list-group list-group-flush">

                <li class="list-group-item"><h4><i class="icon-home icon-large"></i>Recent Posts</h4></li>
                        <li class="list-group-item">
                            <a href="http://jantman.github.io/blog/2014/01/planning-migration-from-wordpress-to-static-site/">
                                Planning Migration from WordPress to Static&nbsp;Site
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="http://jantman.github.io/blog/2013/08/testing-gpg-key-passphrases/">
                                Testing <span class="caps">GPG</span> Key&nbsp;Passphrases
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="http://jantman.github.io/blog/2013/06/quick-tip-timestamping-bash-history/">
                                Quick Tip: Timestamping bash&nbsp;history
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="http://jantman.github.io/blog/2013/06/python-script-to-check-a-list-of-urls-for-return-code-and-final-return-code-if-redirected/">
                                Python script to check a list of URLs for return code, and final return code if&nbsp;redirected
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="http://jantman.github.io/blog/2013/06/modern-0-10-x-nodejs-rpms-on-centosrehl-5-and-6/">
                                Modern (0.10.x+) NodeJS RPMs on CentOS/<span class="caps">REHL</span> 5 and&nbsp;6
                            </a>
                        </li>


                <li class="list-group-item"><a href="http://jantman.github.io/blog/tags.html"><h4><i class="icon-tags icon-large"></i>Tags</h4></a></li>
                <li class="list-group-item">
                        <span class="tag-0">
                            <a href="http://jantman.github.io/blog/tag/linux.html">
                                linux
                            </a>
                        </span>
                        <span class="tag-1">
                            <a href="http://jantman.github.io/blog/tag/google.html">
                                google
                            </a>
                        </span>
                        <span class="tag-1">
                            <a href="http://jantman.github.io/blog/tag/sun.html">
                                sun
                            </a>
                        </span>
                        <span class="tag-1">
                            <a href="http://jantman.github.io/blog/tag/monitoring.html">
                                monitoring
                            </a>
                        </span>
                        <span class="tag-1">
                            <a href="http://jantman.github.io/blog/tag/php.html">
                                PHP
                            </a>
                        </span>
                        <span class="tag-1">
                            <a href="http://jantman.github.io/blog/tag/android.html">
                                android
                            </a>
                        </span>
                        <span class="tag-1">
                            <a href="http://jantman.github.io/blog/tag/microsoft.html">
                                microsoft
                            </a>
                        </span>
                        <span class="tag-1">
                            <a href="http://jantman.github.io/blog/tag/puppet.html">
                                puppet
                            </a>
                        </span>
                        <span class="tag-1">
                            <a href="http://jantman.github.io/blog/tag/wordpress.html">
                                wordpress
                            </a>
                        </span>
                        <span class="tag-1">
                            <a href="http://jantman.github.io/blog/tag/sysadmin.html">
                                sysadmin
                            </a>
                        </span>
                        <span class="tag-1">
                            <a href="http://jantman.github.io/blog/tag/nagios.html">
                                Nagios
                            </a>
                        </span>
                        <span class="tag-2">
                            <a href="http://jantman.github.io/blog/tag/logging.html">
                                logging
                            </a>
                        </span>
                        <span class="tag-2">
                            <a href="http://jantman.github.io/blog/tag/mediawiki.html">
                                mediawiki
                            </a>
                        </span>
                        <span class="tag-2">
                            <a href="http://jantman.github.io/blog/tag/firefox.html">
                                firefox
                            </a>
                        </span>
                        <span class="tag-2">
                            <a href="http://jantman.github.io/blog/tag/dns.html">
                                dns
                            </a>
                        </span>
                        <span class="tag-2">
                            <a href="http://jantman.github.io/blog/tag/syslog.html">
                                syslog
                            </a>
                        </span>
                        <span class="tag-2">
                            <a href="http://jantman.github.io/blog/tag/security.html">
                                security
                            </a>
                        </span>
                        <span class="tag-2">
                            <a href="http://jantman.github.io/blog/tag/rpm.html">
                                rpm
                            </a>
                        </span>
                        <span class="tag-2">
                            <a href="http://jantman.github.io/blog/tag/apache.html">
                                apache
                            </a>
                        </span>
                        <span class="tag-2">
                            <a href="http://jantman.github.io/blog/tag/droid.html">
                                droid
                            </a>
                        </span>
                </li>
        </ul>
    </section>
    <section>
    <ul class="list-group list-group-flush">
    <li class="list-group-item" style="padding: 10px 15px 0px 15px;"><h4><i class="icon-twitter
    icon-large"></i>Twitter <a href="https://twitter.com/j_antman"
    class="twitter-follow-button" data-show-count="false"
    data-dnt="true">Follow @j_antman</a></h4>
<script>!function(d,s,id){var
  js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document,
  'script', 'twitter-wjs');</script></li>
    </ul>
    <a class="twitter-timeline" data-dnt="true"
    href="https://twitter.com/j_antman"
    data-chrome="transparent noheader" data-widget-id="429640274453594113">Tweets by @j_antman</a>
    <script>!function(d,s,id){var
    js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
    </section>
    <section>
    <ul class="list-group list-group-flush">
    <li class="list-group-item"><h4><i class="icon-github icon-large"></i>GitHub Repos</h4></li>
    <li class="list-group-item">
        <div id="gh_repos">
            <p class="list-group-item">Status updating...</p>
        </div>
            <a href="https://github.com/jantman">@jantman</a> on GitHub
        <script type="text/javascript">
            $(document).ready(function () {
                if (!window.jXHR) {
                    var jxhr = document.createElement('script');
                    jxhr.type = 'text/javascript';
                    jxhr.src = 'http://jantman.github.io/blog/theme/js/jXHR.js';
                    var s = document.getElementsByTagName('script')[0];
                    s.parentNode.insertBefore(jxhr, s);
                }

                github.showRepos({
                    user: 'jantman',
                    count: 5,
                    skip_forks: false,
                    target: '#gh_repos'
                });
            });
        </script>
        <script src="http://jantman.github.io/blog/theme/js/github.js" type="text/javascript"></script>
    </li>
    </ul>
    </section>
</aside>        </div>
    </div>
</div>
<footer>
    <div class="container">
        <hr>
        <p class="pull-right"><i class="icon-arrow-up"></i> <a href="#">Back to top</a></p>


        <p>&copy; 2014 Jason Antman &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a></p>
    </div>
</footer>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="http://jantman.github.io/blog/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="http://jantman.github.io/blog/theme/js/respond.min.js"></script>


</body>
</html>