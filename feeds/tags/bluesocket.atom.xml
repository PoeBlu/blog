<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>Jason Antman's Blog - bluesocket</title><link href="http://blog.jasonantman.com/" rel="alternate"></link><link href="http://blog.jasonantman.com/feeds/tags/bluesocket.atom.xml" rel="self"></link><id>http://blog.jasonantman.com/</id><updated>2009-06-27T01:03:00-04:00</updated><entry><title>Daily Work - Nagios SNMP traps, Vyatta, JasonAntman.com upgrades</title><link href="http://blog.jasonantman.com/2009/06/daily-work-nagios-snmp-traps-vyatta-jasonantmancom-upgrades/" rel="alternate"></link><published>2009-06-27T01:03:00-04:00</published><updated>2009-06-27T01:03:00-04:00</updated><author><name>admin</name></author><id>tag:blog.jasonantman.com,2009-06-27:/2009/06/daily-work-nagios-snmp-traps-vyatta-jasonantmancom-upgrades/</id><summary type="html">&lt;p&gt;So it&amp;#8217;s been a very busy day. I was up until 5 &lt;span class="caps"&gt;AM&lt;/span&gt; or so working on
implementing &lt;a href="http://reductivelabs.com/trac/puppet/"&gt;Puppet&lt;/a&gt; at home.
I&amp;#8217;m building two new boxes - a storage (centralized home
directory)/syslog (to MySQL) server and a second web server (possibly
also to handle Nagios) - and I decided …&lt;/p&gt;</summary><content type="html">&lt;p&gt;So it&amp;#8217;s been a very busy day. I was up until 5 &lt;span class="caps"&gt;AM&lt;/span&gt; or so working on
implementing &lt;a href="http://reductivelabs.com/trac/puppet/"&gt;Puppet&lt;/a&gt; at home.
I&amp;#8217;m building two new boxes - a storage (centralized home
directory)/syslog (to MySQL) server and a second web server (possibly
also to handle Nagios) - and I decided that they&amp;#8217;ll be totally built by
Puppet. The only thing I had to give up on was setting up the &lt;span class="caps"&gt;NFS&lt;/span&gt; share
for my home directory on the new storage box and installing and testing
&lt;a href="http://www.rsyslog.com/"&gt;rsyslog&lt;/a&gt; on&amp;nbsp;it.&lt;/p&gt;
&lt;p&gt;This afternoon around 7, I started on my weekend projects for &lt;a href="http://www.midlandparkambulance.com"&gt;the
ambulance corps&lt;/a&gt; - setting up
&lt;a href="http://www.nagios.org"&gt;Nagios&lt;/a&gt; to receive &lt;span class="caps"&gt;SNMP&lt;/span&gt; traps from the &lt;span class="caps"&gt;APC&lt;/span&gt; &lt;span class="caps"&gt;UPS&lt;/span&gt;
and moving over to the new &lt;a href="http://www.vyatta.org"&gt;Vyatta&lt;/a&gt;-based router
(from &lt;a href="http://m0n0.ch/wall/"&gt;m0n0wall&lt;/a&gt;). I&amp;#8217;d attempted the router
before, but had to rollback - I&amp;#8217;m using an old
&lt;a href="http://www.bluesocket.com/"&gt;BlueSocket&lt;/a&gt; controller for hardware - it&amp;#8217;s
just a nice black 1U enclosure with a stock Intel motherboard, &lt;span class="caps"&gt;20GB&lt;/span&gt; &lt;span class="caps"&gt;HDD&lt;/span&gt;,
&lt;span class="caps"&gt;512MB&lt;/span&gt; &lt;span class="caps"&gt;RAM&lt;/span&gt; and three 10/100 NICs. The first time, I was unable to get
link on either of the two NICs I was using, so I decided to&amp;nbsp;rollback.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Nagios &lt;span class="caps"&gt;SNMP&lt;/span&gt;&amp;nbsp;Traps&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;I found a good starting point for Nagios &lt;span class="caps"&gt;SNMP&lt;/span&gt; traps on the &lt;a href="http://altinity.blogs.com/dotorg/2006/03/lessons_in_snmp.html"&gt;OpsView
blog&lt;/a&gt;. I
setup `snmptrapd` on the Nagios server and hacked together a little
Python script to just write all of the traps to a file. After some
testing with `snmptrap` on my laptop, I did a test by pulling the
power plug of the &lt;span class="caps"&gt;UPS&lt;/span&gt;, waiting about 30 seconds, and then plugging it
back in. Sure enough, the little old &lt;a href="/2007/03/apc-ap9605-powernet-snmp-card/"&gt;&lt;span class="caps"&gt;AP9605&lt;/span&gt; PowerNet &lt;span class="caps"&gt;SNMP&lt;/span&gt;
card&lt;/a&gt;
generated two &lt;span class="caps"&gt;SNMP&lt;/span&gt; traps - one for power loss and one for power regained
- both of which showed up in the test&amp;nbsp;file&lt;/p&gt;
&lt;p&gt;The next step will be deciding how to get the traps into Nagios -
specifically whether I want to go with something heavy-weight, like
&lt;a href="http://snmptt.sourceforge.net/"&gt;SNMPtt&lt;/a&gt; that can handle other devices,
or whether I want to code a simple script myself just to deal with the
&lt;span class="caps"&gt;APC&lt;/span&gt;&amp;nbsp;cards.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Router&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;The main reason why I wanted to make the switch from m0n0 to Vyatta was
to ease the setup and maintenance of an IPsec tunnel from the ambulance
&lt;span class="caps"&gt;HQ&lt;/span&gt; to my house, so I could push backups (relatively small) over the &lt;span class="caps"&gt;WAN&lt;/span&gt;
to my infrastructure (or, rather, have Bacula pull the backups). Another
big bonus was finally having a way of configuring and checking things
through &lt;span class="caps"&gt;SSH&lt;/span&gt; without having to port-forward a web &lt;span class="caps"&gt;GUI&lt;/span&gt;. Another bonus of
having a real Linux system under the router is the ability to make
custom Nagios check scripts and easily execute them. Something I hadn&amp;#8217;t
thought of - but became obvious during the switchover - is the ability
to run full-fledged `tcpdump` on the router&amp;nbsp;itself.&lt;/p&gt;
&lt;p&gt;After building the new config myself, and confirming that the system ran
in isolation, I moved it over to production. The first issue was a bit
of a thinko on my part - the interfaces on the &lt;span class="caps"&gt;BSC&lt;/span&gt; are actually arranged
on the back of the box like eth0&amp;#8212;&amp;#8212;-eth2&amp;#8212;&amp;#8212;-eth1, so I originally had
the &lt;span class="caps"&gt;LAN&lt;/span&gt; uplink in the wrong interface. After correcting that and waiting
for the network to stabilize, I noticed a total external connectivity
failure. After some troubleshooting - thanks to tcpdump on the router -
it occurred to me that the (ancient) cable modem needs to be rebooted
when the router &lt;span class="caps"&gt;MAC&lt;/span&gt;&amp;nbsp;changes.&lt;/p&gt;
&lt;p&gt;I honestly don&amp;#8217;t remember the other problems that I ran into, but
eventually I ended up getting almost-full functionality - and then a
total network outage. A tcpdump on my laptop showed some really really
weird &lt;span class="caps"&gt;BOOTP&lt;/span&gt; traffic with addresses of 255.255.255.255. After doing some
troubleshooting and monitoring port counters on the switch, I narrowed
it down to coming from a single Windows box and the wireless access
point. After shutting off both ports, things seemed to stabilize. I also
had some &amp;#8220;martian address&amp;#8221; issues with one of the boxes, but decided to
roll the box and that solved&amp;nbsp;it.&lt;/p&gt;
&lt;p&gt;Over the next day or so, I&amp;#8217;ll be reconfiguring Nagios both at home and
at the ambulance corps to cope with the changes and add in the requisite
monitoring, and keep an eye on things. Assuming all goes well, I&amp;#8217;ll
power down the old router on&amp;nbsp;Sunday.&lt;/p&gt;
&lt;p&gt;On the home front, I&amp;#8217;ve moved over from my old storage machine to the
old one - essentially just the &lt;span class="caps"&gt;NFS&lt;/span&gt; mount, and moved over a tarball of
everything else. I also added a 1000Base-&lt;span class="caps"&gt;SX&lt;/span&gt; card to the new box, though
it appears that I&amp;#8217;m out of fiber patch cords. The old storage box was
brought down for the first time in about 3 years (aside from brief
outages for hardware upgrades or array rebuilds). Assuming I got
everything off of it, it will be relegated to the spares&amp;nbsp;pile.&lt;/p&gt;
&lt;p&gt;I&amp;#8217;m going to make a serious effort to post on a daily basis, if only for
my own future reference. I should have the demo of
&lt;a href="http://rackman.jasonantman.com"&gt;RackMan&lt;/a&gt; out soon, and I&amp;#8217;m also about
to start on integrating it with Nathan Hubbard&amp;#8217;s
&lt;a href="http://www.machdb.org/"&gt;MachDB&lt;/a&gt; as well as a &lt;span class="caps"&gt;PHP&lt;/span&gt; script I wrote to pull
port names and MACs from Cisco switches and associate them with NICs in
machines. Hopefully I&amp;#8217;ll also have some interesting Puppet stuff out&amp;nbsp;soon.&lt;/p&gt;</content><category term="apc"></category><category term="bluesocket"></category><category term="Nagios"></category><category term="snmp"></category><category term="vyatta"></category></entry></feed>