<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>Jason Antman's Blog - dhcp</title><link href="http://blog.jasonantman.com/" rel="alternate"></link><link href="http://blog.jasonantman.com/feeds/tags/dhcp.atom.xml" rel="self"></link><id>http://blog.jasonantman.com/</id><updated>2010-08-06T14:31:00-04:00</updated><entry><title>Short Update</title><link href="http://blog.jasonantman.com/2010/08/short-update/" rel="alternate"></link><published>2010-08-06T14:31:00-04:00</published><updated>2010-08-06T14:31:00-04:00</updated><author><name>admin</name></author><id>tag:blog.jasonantman.com,2010-08-06:/2010/08/short-update/</id><summary type="html">&lt;p&gt;Just a short update&amp;#8230; I know I haven&amp;#8217;t posted anything in quite a
while, but I hope to get back into the habit of doing so&amp;#8230; or even
making daily posts like I had&amp;nbsp;wanted.&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;The &lt;a href="/2010/05/truck-totaled/"&gt;truck that was totaled&lt;/a&gt; has been
    replaced with a newer, nicer&amp;nbsp;one.&lt;/li&gt;
&lt;li&gt;I …&lt;/li&gt;&lt;/ol&gt;</summary><content type="html">&lt;p&gt;Just a short update&amp;#8230; I know I haven&amp;#8217;t posted anything in quite a
while, but I hope to get back into the habit of doing so&amp;#8230; or even
making daily posts like I had&amp;nbsp;wanted.&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;The &lt;a href="/2010/05/truck-totaled/"&gt;truck that was totaled&lt;/a&gt; has been
    replaced with a newer, nicer&amp;nbsp;one.&lt;/li&gt;
&lt;li&gt;I&amp;#8217;ve spent most of the past month working on a large &lt;span class="caps"&gt;DHCP&lt;/span&gt; project at
    work, which I hope to write about in depth at some&amp;nbsp;point.&lt;/li&gt;
&lt;li&gt;I bought the parts to make an Arduino-based &lt;span class="caps"&gt;OBD&lt;/span&gt;-&lt;span class="caps"&gt;II&lt;/span&gt; display, and I&amp;#8217;m
    slowly making some progress on it (mostly delayed because the $12
    &amp;#8220;&lt;span class="caps"&gt;HD44780&lt;/span&gt;-compatible&amp;#8221; &lt;span class="caps"&gt;LCD&lt;/span&gt; display I bought doesn&amp;#8217;t work in 4-bit&amp;nbsp;mode).&lt;/li&gt;
&lt;/ol&gt;</content><category term="arduino"></category><category term="dhcp"></category><category term="truck"></category></entry><entry><title>Xen/Etherboot and DHCP Problems</title><link href="http://blog.jasonantman.com/2010/04/xenetherboot-and-dhcp-problems/" rel="alternate"></link><published>2010-04-20T10:46:00-04:00</published><updated>2010-04-20T10:46:00-04:00</updated><author><name>admin</name></author><id>tag:blog.jasonantman.com,2010-04-20:/2010/04/xenetherboot-and-dhcp-problems/</id><summary type="html">&lt;p&gt;Well, I&amp;#8217;ve spend the better part of the last week or so debugging a
problem with out new Xen VMs (on one host) not getting &lt;span class="caps"&gt;DHCP&lt;/span&gt; leases.
Since our &lt;span class="caps"&gt;DHCP&lt;/span&gt; servers (&lt;span class="caps"&gt;ISC&lt;/span&gt; DHCPd 3.0.6) are using Brian Masney&amp;#8217;s &lt;a href="http://personal.cfw.com/~masneyb/"&gt;&lt;span class="caps"&gt;LDAP&lt;/span&gt;
patch&lt;/a&gt; (which has recently been
included in …&lt;/p&gt;</summary><content type="html">&lt;p&gt;Well, I&amp;#8217;ve spend the better part of the last week or so debugging a
problem with out new Xen VMs (on one host) not getting &lt;span class="caps"&gt;DHCP&lt;/span&gt; leases.
Since our &lt;span class="caps"&gt;DHCP&lt;/span&gt; servers (&lt;span class="caps"&gt;ISC&lt;/span&gt; DHCPd 3.0.6) are using Brian Masney&amp;#8217;s &lt;a href="http://personal.cfw.com/~masneyb/"&gt;&lt;span class="caps"&gt;LDAP&lt;/span&gt;
patch&lt;/a&gt; (which has recently been
included in &lt;a href="http://www.isc.org/files/release-notes/42b2_0.html"&gt;mainline
DHCPd&lt;/a&gt;), I assumed
that this might be the source of some of the&amp;nbsp;problems.&lt;/p&gt;
&lt;p&gt;The Xen client booting process uses &lt;a href="http://etherboot.org/"&gt;Etherboot&lt;/a&gt;
(specifically 5.4.2 on my machines) to get &lt;span class="caps"&gt;DHCP&lt;/span&gt; and &lt;span class="caps"&gt;PXE&lt;/span&gt; for the client.
The Etherboot &lt;span class="caps"&gt;ROM&lt;/span&gt; is generated online with
&lt;a href="http://rom-o-matic.net/"&gt;&lt;span class="caps"&gt;ROM&lt;/span&gt;-o-Matic&lt;/a&gt; (by the Xen devs) and is then
packaged into &lt;code&gt;hvmloader&lt;/code&gt; (though I would not find this out until much
later in my investigation, given the piss-poor documentation about it).
So, aside from pulling the &lt;span class="caps"&gt;SRPM&lt;/span&gt; for Xen and looking around, I decided I
couldn&amp;#8217;t really debug much on the client end (I wasn&amp;#8217;t getting any
&lt;span class="caps"&gt;BIOS&lt;/span&gt;-like messages from Xen, so the client end seemed to be pretty much
a black&amp;nbsp;box).&lt;/p&gt;
&lt;p&gt;After a week of re-examining our &lt;span class="caps"&gt;DHCP&lt;/span&gt; servers, moving the client between
pieces of hardware and different networks, tracing out the &lt;span class="caps"&gt;DHCP&lt;/span&gt; logs,
and debugging everything in-between, I finally resorted to doing packet
captures and analyzing them. Last Thursday (my last work day of the
week), I popped my laptop on the same network, set it up in &lt;span class="caps"&gt;DHCP&lt;/span&gt;, and
did some captures of the laptop (which worked correctly) and the problem&amp;nbsp;&lt;span class="caps"&gt;VM&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;Sometime around 10:00 &lt;span class="caps"&gt;PM&lt;/span&gt;, long after I&amp;#8217;d gotten home, I had opened
captures of both the good and bad hosts in separate
&lt;a href="http://www.wireshark.org/"&gt;Wireshark&lt;/a&gt; windows, and was going through
them line-by-line. I&amp;#8217;d also written a nifty little &lt;a href="/GFX/dhcptest.pl"&gt;Perl
script&lt;/a&gt; (my weakest language) using
&lt;a href="http://search.cpan.org/~fvandun/Net-DHCP-0.11/lib/Net/DHCP/Packet.pm"&gt;Net::&lt;span class="caps"&gt;DHCP&lt;/span&gt;::Packet&lt;/a&gt;
to craft packets identical to the ones from the working and &lt;span class="caps"&gt;FUBAR&lt;/span&gt; hosts,
and inject them into the network. The only thing I could find different
was the value of the &amp;#8220;secs&amp;#8221; field of the &lt;span class="caps"&gt;DHCPDISCOVER&lt;/span&gt; packets (octets 9
and 10), which are supposed to contain the number of seconds that have
passed since the host started booting (&lt;a href="http://www.faqs.org/rfcs/rfc1541.html"&gt;&lt;span class="caps"&gt;RFC&lt;/span&gt;
1541&lt;/a&gt;). My laptop (the working
host) started getting replies from the server at 21 seconds. I took my
Perl packet-injecting script, and started adjusting the &amp;#8220;secs&amp;#8221; values of
both the working and bad packets. Sure enough, with identical packets
from each host, the values converged. Anything with &amp;#8220;secs&amp;#8221; below 2 got
no response from the &lt;span class="caps"&gt;DHCP&lt;/span&gt; server, anything with 2 or greater got a
correct&amp;nbsp;lease.&lt;/p&gt;
&lt;p&gt;Then it hit me. When we used to have a primary/secondary &lt;span class="caps"&gt;DHCP&lt;/span&gt; server
setup (with manual failover), we&amp;#8217;d configured the secondary server with
&lt;code&gt;min-secs: 2&lt;/code&gt;, instructing it to not give out any leases to clients with
a &amp;#8220;secs&amp;#8221; value of under 2, to prevent the secondary server from
answering if, for some reason, the primary was still online.&amp;nbsp;Bingo.&lt;/p&gt;
&lt;p&gt;At this point, I&amp;#8217;m waiting to have a meeting of the binds before I add a
network-level override of &amp;#8220;min-secs: 0&amp;#8221; for the networks in question.
But I&amp;#8217;m relatively confident that everything will go smoothly from there&amp;nbsp;on.&lt;/p&gt;
&lt;p&gt;This experience highlighted that one small &amp;#8220;bug&amp;#8221; can confuse 3 people
for the better part of a&amp;nbsp;week:&lt;/p&gt;
&lt;p&gt;&lt;a href="http://etherboot.org/"&gt;Etherboot&lt;/a&gt; (at least 5.4.2) doesn&amp;#8217;t increment
the &amp;#8220;secs&amp;#8221; field in its &lt;span class="caps"&gt;DISCOVER&lt;/span&gt; packets as &lt;span class="caps"&gt;RFC&lt;/span&gt; 1541 suggests. Therefore
anyone with &amp;#8220;min-secs&amp;#8221; in their dhcpd configuration won&amp;#8217;t ever give out
a&amp;nbsp;lease.&lt;/p&gt;
&lt;p&gt;In hindsight, it really was a brain-dead moment. There was a little note
in the dhcpd logs that I, and the others, totally overlooked:
&amp;#8220;&lt;span class="caps"&gt;DHCPDISCOVER&lt;/span&gt; (&amp;#8230;) 0 secs &amp;lt; 2&amp;#8221;. I guess I should have turned my brain
on and realized that those few characters were probably important, and
there for a reason, no matter how unassuming (and un-error-like) they
may&amp;nbsp;be&amp;#8230;&lt;/p&gt;</content><category term="dhcp"></category><category term="dhcpd"></category><category term="etherboot"></category><category term="ldap"></category><category term="pxe"></category><category term="xen"></category></entry><entry><title>DHCP Debugging and Handy TCPdump filters</title><link href="http://blog.jasonantman.com/2010/04/dhcp-debugging-and-handy-tcpdump-filters/" rel="alternate"></link><published>2010-04-14T09:21:00-04:00</published><updated>2010-04-14T09:21:00-04:00</updated><author><name>admin</name></author><id>tag:blog.jasonantman.com,2010-04-14:/2010/04/dhcp-debugging-and-handy-tcpdump-filters/</id><summary type="html">&lt;p&gt;Recently at $&lt;span class="caps"&gt;WORK&lt;/span&gt; we&amp;#8217;ve been having some strange issues with a
particular Xen &lt;span class="caps"&gt;VM&lt;/span&gt; not getting &lt;span class="caps"&gt;DHCP&lt;/span&gt;. Traditional (tail -f dhcpd.log)
debugging hasn&amp;#8217;t turned up much, other than the server is getting the
&lt;span class="caps"&gt;DISCOVER&lt;/span&gt; but not sending out an &lt;span class="caps"&gt;OFFER&lt;/span&gt;. I&amp;#8217;ve turned to packet captures to …&lt;/p&gt;</summary><content type="html">&lt;p&gt;Recently at $&lt;span class="caps"&gt;WORK&lt;/span&gt; we&amp;#8217;ve been having some strange issues with a
particular Xen &lt;span class="caps"&gt;VM&lt;/span&gt; not getting &lt;span class="caps"&gt;DHCP&lt;/span&gt;. Traditional (tail -f dhcpd.log)
debugging hasn&amp;#8217;t turned up much, other than the server is getting the
&lt;span class="caps"&gt;DISCOVER&lt;/span&gt; but not sending out an &lt;span class="caps"&gt;OFFER&lt;/span&gt;. I&amp;#8217;ve turned to packet captures to
try and track down the problem. Of course, this is where
&lt;a href="http://www.tcpdump.org/"&gt;tcpdump&lt;/a&gt; and
&lt;a href="http://www.wireshark.org/"&gt;wireshark&lt;/a&gt; come into play. So I thought I&amp;#8217;d
share some of the filters that I&amp;#8217;ve been using, and a few that I&amp;nbsp;developed.&lt;/p&gt;
&lt;p&gt;tcpdump filter for &lt;span class="caps"&gt;CDP&lt;/span&gt; (I should have this memorized by now) from
&lt;a href="http://sidewynder.blogspot.com/2005/07/tcpdump-filter-for-capturing-only.html"&gt;SWeidner&lt;/a&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;tcpdump -nn -v -i eth0 -s &lt;span class="m"&gt;1500&lt;/span&gt; -c &lt;span class="m"&gt;1&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;ether[20:2] == 0x2000&amp;#39;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Wireshark display filter for a specific &lt;span class="caps"&gt;DHCP&lt;/span&gt; client (by&amp;nbsp;&lt;span class="caps"&gt;MAC&lt;/span&gt;):&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;bootp.hw.mac_addr == 00:11:22:33:44:55
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;tcpdump filter to match &lt;span class="caps"&gt;DHCP&lt;/span&gt; packets including a specific Client &lt;span class="caps"&gt;MAC&lt;/span&gt;&amp;nbsp;Address:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;tcpdump -i br0 -vvv -s &lt;span class="m"&gt;1500&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;((port 67 or port 68) and (udp[38:4] = 0x3e0ccf08))&amp;#39;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;tcpdump only allows matching on a maximum of 4 bytes (octets), not the 6
bytes of a &lt;span class="caps"&gt;MAC&lt;/span&gt; address. So, in the above example, we match the last 4
bytes (presumably the most unique) - our original &lt;span class="caps"&gt;MAC&lt;/span&gt; address was
&lt;code&gt;00:16:3e:0c:cf:08&lt;/code&gt;, so we match on &lt;code&gt;3e0ccf08&lt;/code&gt;. The &lt;code&gt;udp[38:4]&lt;/code&gt; matches
from the 38th octet after the start of the &lt;span class="caps"&gt;UDP&lt;/span&gt; header (so the comparison
starts on the 39th octet) and compares a chunk 4 octets long. The &lt;a href="http://www.networksorcery.com/enp/protocol/udp.htm"&gt;&lt;span class="caps"&gt;UDP&lt;/span&gt;
header&lt;/a&gt; is 8 octets
long, followed immediately by the &lt;a href="http://www.networksorcery.com/enp/protocol/dhcp.htm"&gt;&lt;span class="caps"&gt;DHCP&lt;/span&gt;
header&lt;/a&gt;, and the
Client &lt;span class="caps"&gt;MAC&lt;/span&gt; Address field is composed of octets 29-35 of the &lt;span class="caps"&gt;DHCP&lt;/span&gt; header.
Therefore, 8 octets for &lt;span class="caps"&gt;UDP&lt;/span&gt; header + 28 octets until Client &lt;span class="caps"&gt;MAC&lt;/span&gt; Address
+ 2 octets offset (drop the first 2 octets of &lt;span class="caps"&gt;MAC&lt;/span&gt; address to allow a 4
octet comparison) = 38 (our total&amp;nbsp;offset).&lt;/p&gt;
&lt;p&gt;This can also be modified as a Wireshark display&amp;nbsp;filter:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;udp[38:4]==3e:0c:cf:08
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Using the same logic, a tcpdump filter to capture packets sent by the
client (&lt;span class="caps"&gt;DISCOVER&lt;/span&gt;, &lt;span class="caps"&gt;REQUEST&lt;/span&gt;,&amp;nbsp;&lt;span class="caps"&gt;INFORM&lt;/span&gt;):&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;tcpdump -i br0 -vvv -s &lt;span class="m"&gt;1500&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;((port 67 or port 68) and (udp[8:1] = 0x1))&amp;#39;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Finally, a tcpdump filter for &lt;span class="caps"&gt;DHCPDISCOVER&lt;/span&gt; packets (this makes the
possibly flawed ass-umption that Option 53 will be the first option&amp;nbsp;set:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;udp[247:4] = 0x63350101
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;and a wireshark display&amp;nbsp;filter:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;udp[247:4]==63:35:01:01
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;And the same thing for &lt;span class="caps"&gt;DHCPREQUEST&lt;/span&gt;&amp;nbsp;packets:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;udp[247:4] = 0x63350103
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;and a wireshark display&amp;nbsp;filter:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;udp[247:4]==63:35:01:03
&lt;/pre&gt;&lt;/div&gt;</content><category term="dhcp"></category><category term="tcpdump"></category><category term="wireshark"></category></entry><entry><title>BIND9 Dynamic DNS</title><link href="http://blog.jasonantman.com/2010/04/bind9-dynamic-dns/" rel="alternate"></link><published>2010-04-07T09:04:00-04:00</published><updated>2010-04-07T09:04:00-04:00</updated><author><name>admin</name></author><id>tag:blog.jasonantman.com,2010-04-07:/2010/04/bind9-dynamic-dns/</id><summary type="html">&lt;p&gt;I needed a better solution for Dynamic &lt;span class="caps"&gt;DNS&lt;/span&gt; than
&lt;a href="http://www.dyndns.org"&gt;dyndns.org&lt;/a&gt; for something, so I set about
setting up &lt;span class="caps"&gt;DDNS&lt;/span&gt; through my &lt;span class="caps"&gt;BIND9&lt;/span&gt; servers. I found a number of very
helpful blog posts, including &lt;a href="http://linux.yyz.us/nsupdate/"&gt;nsupdate: Painless Dynamic
&lt;span class="caps"&gt;DNS&lt;/span&gt;&lt;/a&gt;, &lt;a href="http://linux.yyz.us/dns/ddns-server.html"&gt;Painless &lt;span class="caps"&gt;DDNS&lt;/span&gt; part 2: the
server&lt;/a&gt;, &lt;a href="http://ops.ietf.org/dns/dynupd/secure-ddns-howto.html"&gt;Secure dynamic &lt;span class="caps"&gt;DNS&lt;/span&gt;
howto&lt;/a&gt; and &lt;a href="http://www.oceanwave.com/technical-resources/unix-admin/nsupdate.html"&gt;A …&lt;/a&gt;&lt;/p&gt;</summary><content type="html">&lt;p&gt;I needed a better solution for Dynamic &lt;span class="caps"&gt;DNS&lt;/span&gt; than
&lt;a href="http://www.dyndns.org"&gt;dyndns.org&lt;/a&gt; for something, so I set about
setting up &lt;span class="caps"&gt;DDNS&lt;/span&gt; through my &lt;span class="caps"&gt;BIND9&lt;/span&gt; servers. I found a number of very
helpful blog posts, including &lt;a href="http://linux.yyz.us/nsupdate/"&gt;nsupdate: Painless Dynamic
&lt;span class="caps"&gt;DNS&lt;/span&gt;&lt;/a&gt;, &lt;a href="http://linux.yyz.us/dns/ddns-server.html"&gt;Painless &lt;span class="caps"&gt;DDNS&lt;/span&gt; part 2: the
server&lt;/a&gt;, &lt;a href="http://ops.ietf.org/dns/dynupd/secure-ddns-howto.html"&gt;Secure dynamic &lt;span class="caps"&gt;DNS&lt;/span&gt;
howto&lt;/a&gt; and &lt;a href="http://www.oceanwave.com/technical-resources/unix-admin/nsupdate.html"&gt;A
&lt;span class="caps"&gt;DDNS&lt;/span&gt; Server Using &lt;span class="caps"&gt;BIND&lt;/span&gt; and
Nsupdate&lt;/a&gt;.
Of course, the &lt;a href="http://www.zytrax.com/books/dns/ch7/statements.html"&gt;&lt;span class="caps"&gt;BIND&lt;/span&gt; configuration statement
reference&lt;/a&gt; was also
very&amp;nbsp;helpful.&lt;/p&gt;
&lt;p&gt;The whole process was relatively&amp;nbsp;simple&amp;#8230;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Add an &lt;span class="caps"&gt;RR&lt;/span&gt; for the host I want, in the appropriate&amp;nbsp;zone.&lt;/li&gt;
&lt;li&gt;Generate &lt;span class="caps"&gt;TSIG&lt;/span&gt; keys, distribute them to the&amp;nbsp;client.&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Make sure you have logging enabled for things of interest in your
    &lt;code&gt;logging&lt;/code&gt; section of &lt;code&gt;named.conf&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;category dnssec { syslog_info; };
category update { syslog_info; };
category security { syslog_info; };
&lt;/pre&gt;&lt;/div&gt;


&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Create a keys.conf file for your keys (you &lt;em&gt;do&lt;/em&gt; split your configs
    out into usable chunks,&amp;nbsp;right?):&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;key foo.example.com. {
    algorithm &lt;span class="caps"&gt;HMAC&lt;/span&gt;-&lt;span class="caps"&gt;MD5&lt;/span&gt;.&lt;span class="caps"&gt;SIG&lt;/span&gt;-&lt;span class="caps"&gt;ALG&lt;/span&gt;.&lt;span class="caps"&gt;REG&lt;/span&gt;.&lt;span class="caps"&gt;INT&lt;/span&gt;;
    secret &amp;quot;this is your secret here (after Key: in the .private file)&amp;quot;;
};
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;and include it in &lt;code&gt;named.conf&lt;/code&gt; like:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;include &amp;quot;/etc/named.d/keys.conf&amp;quot;;
&lt;/pre&gt;&lt;/div&gt;


&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Set an
    &lt;a href="http://www.zytrax.com/books/dns/ch7/xfer.html#update-policy"&gt;&lt;code&gt;update-policy&lt;/code&gt;&lt;/a&gt;
    statement in &lt;code&gt;named.conf&lt;/code&gt;. I just added mine to a specific zone in a
    specific view (external), as that&amp;#8217;s the only place I would
    conceivably want updates right&amp;nbsp;now.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;update-policy {
    grant * self * A &lt;span class="caps"&gt;TXT&lt;/span&gt;;
};
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Assuming your &lt;span class="caps"&gt;TSIG&lt;/span&gt; keys are named for specific RRs, this will let
any client (with a valid key setup on the server) update its own &lt;span class="caps"&gt;RR&lt;/span&gt;
and nothing&amp;nbsp;else.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Finally, I created a script for ddns updates on the client. Since I
    want to be able to fire off this script manually or via cron (if I
    have to reload &lt;span class="caps"&gt;BIND&lt;/span&gt;, and until I make the needed changes to
    MultiBINDadmin), I bypassed the usual dhclient stuff and manually
    grab the current &lt;span class="caps"&gt;IP&lt;/span&gt; from the interface of interest. I symlinked this
    in &lt;code&gt;/etc/dhcp3/dhclient-exit-hooks.d&lt;/code&gt; so it will run on &lt;span class="caps"&gt;DHCP&lt;/span&gt;&amp;nbsp;updates.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="ch"&gt;#!/bin/bash&lt;/span&gt;
&lt;span class="nv"&gt;&lt;span class="caps"&gt;IFACE&lt;/span&gt;&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;eth0&amp;quot;&lt;/span&gt;
&lt;span class="nv"&gt;&lt;span class="caps"&gt;TTL&lt;/span&gt;&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;3600&lt;/span&gt;
&lt;span class="nv"&gt;&lt;span class="caps"&gt;SERVER&lt;/span&gt;&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;ns1.example.com
&lt;span class="nv"&gt;&lt;span class="caps"&gt;HOSTNAME&lt;/span&gt;&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;foo.example.com
&lt;span class="nv"&gt;&lt;span class="caps"&gt;ZONE&lt;/span&gt;&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;example.com
&lt;span class="nv"&gt;&lt;span class="caps"&gt;KEYFILE&lt;/span&gt;&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;/root/ddns-keys/Kfoo.example.com.+157+12345.private

&lt;span class="nv"&gt;new_ip_address&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="sb"&gt;`&lt;/span&gt;ifconfig &lt;span class="nv"&gt;$&lt;span class="caps"&gt;IFACE&lt;/span&gt;&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; grep &lt;span class="s2"&gt;&amp;quot;inet addr:&amp;quot;&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; awk &lt;span class="s1"&gt;&amp;#39;{print $2}&amp;#39;&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; awk -F &lt;span class="s2"&gt;&amp;quot;:&amp;quot;&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;{print $2}&amp;#39;&lt;/span&gt;&lt;span class="sb"&gt;`&lt;/span&gt;
&lt;span class="nv"&gt;new_ip_address&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;new_ip_address&lt;/span&gt;&lt;span class="p"&gt;/ /&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;

nsupdate -v -k &lt;span class="nv"&gt;$&lt;span class="caps"&gt;KEYFILE&lt;/span&gt;&lt;/span&gt; &lt;span class="s"&gt;&amp;lt;&amp;lt; &lt;span class="caps"&gt;EOF&lt;/span&gt;&lt;/span&gt;
&lt;span class="s"&gt;server $&lt;span class="caps"&gt;SERVER&lt;/span&gt;&lt;/span&gt;
&lt;span class="s"&gt;zone $&lt;span class="caps"&gt;ZONE&lt;/span&gt;&lt;/span&gt;
&lt;span class="s"&gt;update delete $&lt;span class="caps"&gt;HOSTNAME&lt;/span&gt; A&lt;/span&gt;
&lt;span class="s"&gt;update add $&lt;span class="caps"&gt;HOSTNAME&lt;/span&gt; $&lt;span class="caps"&gt;TTL&lt;/span&gt; A $new_ip_address&lt;/span&gt;
&lt;span class="s"&gt;send&lt;/span&gt;
&lt;span class="s"&gt;&lt;span class="caps"&gt;EOF&lt;/span&gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;When I finally got things setup, my only problem was with permissions on
the zone file directories, which was easily corrected.Once this was
straightened out, my &lt;code&gt;nsupdate&lt;/code&gt; script ran flawlessly, and the update
was instantly (thanks to using &amp;#8220;notify&amp;#8221;) propagated out to the slave&amp;nbsp;server.&lt;/p&gt;
&lt;p&gt;The only problem that I now have is one of my own creation - I use a
small &lt;span class="caps"&gt;PHP&lt;/span&gt; application that I wrote
(&lt;a href="http://multibindadmin.jasonantman.com/"&gt;MultiBINDadmin&lt;/a&gt;) to manage
&lt;span class="caps"&gt;DNS&lt;/span&gt;. It&amp;#8217;s incredibly easy, as it keeps track of internal and external
IPs, and everything else, for my zones, and triggers a pull on the
master &lt;span class="caps"&gt;BIND&lt;/span&gt; server via the web interface. The only problem I now have is
that this messes with &lt;span class="caps"&gt;DDNS&lt;/span&gt; updates. First, if I make changes in the web
interface and there&amp;#8217;s already been a &lt;span class="caps"&gt;DDNS&lt;/span&gt; update that day, the zone
serial generated by MultiBINDadmin will match the automatically
incremented serial generated by the &lt;span class="caps"&gt;BIND&lt;/span&gt; server. Second, and more
troubling, when the &lt;span class="caps"&gt;BIND&lt;/span&gt; server reloads, it loses the dynamic update. So
when I push changes to a zone from the web interface, my dynamic updates
go&amp;nbsp;away.&lt;/p&gt;
&lt;p&gt;For the short-term, I&amp;#8217;m just going to check the zone serial before I
make any updates and, if need be, manually increment it in the web tool.
As to losing the dynamic updates, I&amp;#8217;m just going to have cron on the
client fire the &lt;code&gt;nsupdate&lt;/code&gt; script every 30 minutes. I also did a little
kludge, setup a vhost on one of my web servers to answer for the dynamic
host (as a catch-all page), and set the &lt;span class="caps"&gt;IP&lt;/span&gt; of my web server as the
hard-coded &lt;span class="caps"&gt;RR&lt;/span&gt; address in the zone file. If someone tries to use the new
(&lt;span class="caps"&gt;DDNS&lt;/span&gt; through my &lt;span class="caps"&gt;BIND&lt;/span&gt; server) address for &lt;span class="caps"&gt;HTTP&lt;/span&gt; and for some reason the
current dynamic address disappeared (&lt;span class="caps"&gt;BIND&lt;/span&gt; reloaded), they&amp;#8217;ll get a
little page with a message and the old dyndns.org-based&amp;nbsp;&lt;span class="caps"&gt;URL&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;When I get around to it (or when this becomes a problem), I&amp;#8217;ll make two
changes to&amp;nbsp;MultiBINDadmin:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Before it pushes an update, check the current serial for the zone
    (ok, this may be a bit interesting, as the internal and external
    zones could have different serials) and increment from&amp;nbsp;that.&lt;/li&gt;
&lt;li&gt;Have a &amp;#8220;&lt;span class="caps"&gt;DDNS&lt;/span&gt;&amp;#8221; flag in the database and &lt;span class="caps"&gt;GUI&lt;/span&gt; for RRs. For all flagged
    RRs, try to get the (unfortunately external) current address and
    update the record in the &lt;span class="caps"&gt;DB&lt;/span&gt; before the&amp;nbsp;push.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;The real question here, which I haven&amp;#8217;t looked into yet, is how I can
interrogate &lt;span class="caps"&gt;BIND&lt;/span&gt; about RRs for the external zone from an internal&amp;nbsp;host.&lt;/p&gt;</content><category term="bind"></category><category term="ddns"></category><category term="dhcp"></category><category term="multibindadmin"></category></entry><entry><title>Using nmap to quickly ping all hosts in an address range</title><link href="http://blog.jasonantman.com/2010/02/using-nmap-to-quickly-ping-all-hosts-in-an-address-range/" rel="alternate"></link><published>2010-02-08T09:10:00-05:00</published><updated>2010-02-08T09:10:00-05:00</updated><author><name>admin</name></author><id>tag:blog.jasonantman.com,2010-02-08:/2010/02/using-nmap-to-quickly-ping-all-hosts-in-an-address-range/</id><summary type="html">&lt;p&gt;At $&lt;span class="caps"&gt;WORK&lt;/span&gt;, the subnet we use for some of our workstations and test boxes
was only recently setup with &lt;span class="caps"&gt;DHCP&lt;/span&gt;. Previously, we&amp;#8217;d used
&lt;span class="caps"&gt;IP&lt;/span&gt;-by-Whiteboard in the office. As a result, most of the recent machines
use &lt;span class="caps"&gt;DHCP&lt;/span&gt;, but there are a few older ones still around using static …&lt;/p&gt;</summary><content type="html">&lt;p&gt;At $&lt;span class="caps"&gt;WORK&lt;/span&gt;, the subnet we use for some of our workstations and test boxes
was only recently setup with &lt;span class="caps"&gt;DHCP&lt;/span&gt;. Previously, we&amp;#8217;d used
&lt;span class="caps"&gt;IP&lt;/span&gt;-by-Whiteboard in the office. As a result, most of the recent machines
use &lt;span class="caps"&gt;DHCP&lt;/span&gt;, but there are a few older ones still around using static
addresses. I recently had to add a new machine, so I had to go through
the process of finding out which IPs are in use and which aren&amp;#8217;t (since
some aren&amp;#8217;t in&amp;nbsp;&lt;span class="caps"&gt;DHCP&lt;/span&gt;).&lt;/p&gt;
&lt;p&gt;I decided to be good and update &lt;span class="caps"&gt;DHCP&lt;/span&gt; with records for all machines in
the subnet, whether they&amp;#8217;re actually using &lt;span class="caps"&gt;DHCP&lt;/span&gt; or not. There&amp;#8217;s a quick
way to do this with &lt;code&gt;nmap&lt;/code&gt; using the options for ping scan (&lt;code&gt;-sP&lt;/code&gt;) and
always resolve &lt;span class="caps"&gt;DNS&lt;/span&gt; (&lt;code&gt;-R&lt;/code&gt;):&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="gp"&gt;#&lt;/span&gt; nmap -sP -R &lt;span class="m"&gt;172&lt;/span&gt;.16.43.129-159
&lt;span class="go"&gt;Host ar01-hill-hill.example.com (172.16.43.129) appears to be up.&lt;/span&gt;
&lt;span class="go"&gt;&lt;span class="caps"&gt;MAC&lt;/span&gt; Address: 00:11:&lt;span class="caps"&gt;BC&lt;/span&gt;:7D:28:0A (Cisco Systems)&lt;/span&gt;
&lt;span class="go"&gt;Host ccf-hill019-1.example.com (172.16.43.130) appears to be up.&lt;/span&gt;
&lt;span class="go"&gt;&lt;span class="caps"&gt;MAC&lt;/span&gt; Address: 00:00:&lt;span class="caps"&gt;AA&lt;/span&gt;:63:54:&lt;span class="caps"&gt;BB&lt;/span&gt; (Xerox)&lt;/span&gt;
&lt;span class="go"&gt;Host ccf-hill019-2.example.com (172.16.43.131) appears to be down.&lt;/span&gt;
&lt;span class="go"&gt;Host ccf-hill019-3.example.com (172.16.43.132) appears to be down.&lt;/span&gt;
&lt;span class="go"&gt;Host ccf-hill019-4.example.com (172.16.43.133) appears to be down.&lt;/span&gt;
&lt;span class="go"&gt;Host ccf-hill019-5.example.com (172.16.43.134) appears to be down.&lt;/span&gt;
&lt;span class="go"&gt;Host ccf-hill019-6.example.com (172.16.43.135) appears to be down.&lt;/span&gt;
&lt;span class="go"&gt;Host ccf-hill019-7.example.com (172.16.43.136) appears to be up.&lt;/span&gt;
&lt;span class="go"&gt;Host speakeasy.example.com (172.16.43.137) appears to be up.&lt;/span&gt;
&lt;span class="go"&gt;&lt;span class="caps"&gt;MAC&lt;/span&gt; Address: 00:17:A4:13:&lt;span class="caps"&gt;EB&lt;/span&gt;:57 (Global Data Services)&lt;/span&gt;
&lt;span class="go"&gt;Host ccf-hill019-9.example.com (172.16.43.138) appears to be up.&lt;/span&gt;
&lt;span class="go"&gt;&lt;span class="caps"&gt;MAC&lt;/span&gt; Address: 00:17:A4:13:E8:17 (Global Data Services)&lt;/span&gt;
&lt;span class="go"&gt;Host ccf-hill019-10.example.com (172.16.43.139) appears to be down.&lt;/span&gt;
&lt;span class="go"&gt;Host testmac01.example.com (172.16.43.140) appears to be down.&lt;/span&gt;
&lt;span class="go"&gt;Host ccf-hill019-12.example.com (172.16.43.141) appears to be down.&lt;/span&gt;
&lt;span class="go"&gt;Host ccf-hill019-13.example.com (172.16.43.142) appears to be up.&lt;/span&gt;
&lt;span class="go"&gt;&lt;span class="caps"&gt;MAC&lt;/span&gt; Address: 00:0D:29:59:58:00 (Cisco)&lt;/span&gt;
&lt;span class="go"&gt;Host ccf-hill019-14.example.com (172.16.43.143) appears to be down.&lt;/span&gt;
&lt;span class="go"&gt;Host ccf-hill019-15.example.com (172.16.43.144) appears to be down.&lt;/span&gt;
&lt;span class="go"&gt;Host ccf-hill019-16.example.com (172.16.43.145) appears to be down.&lt;/span&gt;
&lt;span class="go"&gt;Host ccf-hill019-17.example.com (172.16.43.146) appears to be down.&lt;/span&gt;
&lt;span class="go"&gt;Host ccf-hill019-18.example.com (172.16.43.147) appears to be up.&lt;/span&gt;
&lt;span class="go"&gt;&lt;span class="caps"&gt;MAC&lt;/span&gt; Address: 00:1E:C2:0D:C1:98 (Unknown)&lt;/span&gt;
&lt;span class="go"&gt;Host ccf-hill019-19.example.com (172.16.43.148) appears to be down.&lt;/span&gt;
&lt;span class="go"&gt;Host ccf-hill019-20.example.com (172.16.43.149) appears to be down.&lt;/span&gt;
&lt;span class="go"&gt;Host ccf-hill019-21.example.com (172.16.43.150) appears to be down.&lt;/span&gt;
&lt;span class="go"&gt;Host lordkris.example.com (172.16.43.151) appears to be down.&lt;/span&gt;
&lt;span class="go"&gt;Host ccf-hill019-23.example.com (172.16.43.152) appears to be down.&lt;/span&gt;
&lt;span class="go"&gt;Host ccf-hill019-24.example.com (172.16.43.153) appears to be down.&lt;/span&gt;
&lt;span class="go"&gt;Host ccf-hill019-25.example.com (172.16.43.154) appears to be down.&lt;/span&gt;
&lt;span class="go"&gt;Host ccf-hill019-26.example.com (172.16.43.155) appears to be down.&lt;/span&gt;
&lt;span class="go"&gt;Host ccf-hill019-27.example.com (172.16.43.156) appears to be down.&lt;/span&gt;
&lt;span class="go"&gt;Host ccf-hill019-28.example.com (172.16.43.157) appears to be down.&lt;/span&gt;
&lt;span class="go"&gt;Host ccf-hill019-29.example.com (172.16.43.158) appears to be down.&lt;/span&gt;
&lt;span class="go"&gt;Host ccf-hill019-30.example.com (172.16.43.159) appears to be down.&lt;/span&gt;
&lt;span class="go"&gt;Nmap finished: 31 &lt;span class="caps"&gt;IP&lt;/span&gt; addresses (7 hosts up) scanned in 0.892 seconds&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;As you can see, the results also (very usefully) include &lt;span class="caps"&gt;MAC&lt;/span&gt; addresses,
so it&amp;#8217;s pretty easy to update &lt;span class="caps"&gt;DHCP&lt;/span&gt; as&amp;nbsp;needed.&lt;/p&gt;</content><category term="dhcp"></category><category term="nmap"></category><category term="ping"></category><category term="sysadmin"></category></entry><entry><title>Brother HL2170W DHCP Problems</title><link href="http://blog.jasonantman.com/2009/04/brother-hl2170w-dhcp-problems/" rel="alternate"></link><published>2009-04-11T11:53:00-04:00</published><updated>2009-04-11T11:53:00-04:00</updated><author><name>admin</name></author><id>tag:blog.jasonantman.com,2009-04-11:/2009/04/brother-hl2170w-dhcp-problems/</id><summary type="html">&lt;p&gt;Two weeks ago, I &lt;a href="/2009/03/brother-hl-2170w-great-features-from-a-personal-laser-printer/"&gt;wrote about the Brother
&lt;span class="caps"&gt;HL&lt;/span&gt;-2170W&lt;/a&gt;
that I got for my mother. It seemed absolutely wonderful. Until the
night of March 31st, just before Conficker was supposed to strike. Being
that mom&amp;#8217;s computer is the only one at home running Windows, I finished
up a …&lt;/p&gt;</summary><content type="html">&lt;p&gt;Two weeks ago, I &lt;a href="/2009/03/brother-hl-2170w-great-features-from-a-personal-laser-printer/"&gt;wrote about the Brother
&lt;span class="caps"&gt;HL&lt;/span&gt;-2170W&lt;/a&gt;
that I got for my mother. It seemed absolutely wonderful. Until the
night of March 31st, just before Conficker was supposed to strike. Being
that mom&amp;#8217;s computer is the only one at home running Windows, I finished
up a long-standing project - and moved her desktop, printer, and AppleTV
over to a separate &lt;span class="caps"&gt;VLAN&lt;/span&gt; that&amp;#8217;s not routable to anything else internal
(i.e. anything important, or anything of mine). I&amp;#8217;d already had the
&amp;#8220;client&amp;#8221; &lt;span class="caps"&gt;VLAN&lt;/span&gt; setup for a while, so it was just a matter of tweaking the
firewall rules and moving the static &lt;span class="caps"&gt;DHCP&lt;/span&gt; assignments from one subnet to
the&amp;nbsp;other.&lt;/p&gt;
&lt;p&gt;Well, that&amp;#8217;s where the problems started. While her Windows &lt;span class="caps"&gt;XP&lt;/span&gt; desktop
and AppleTV coped nicely, and got their new addresses in &lt;span class="caps"&gt;DHCP&lt;/span&gt; as they
should, the &lt;span class="caps"&gt;HL2170W&lt;/span&gt; did not, As a matter of fact, after two hours, I
hadn&amp;#8217;t seen a single &lt;span class="caps"&gt;DHCP&lt;/span&gt; request, even though I had the lease time set
to 10 minutes for both subnets. So, I tried administratively downing the
switch port a few times, to no avail. After a day of waiting, I came
back to the problem - and &lt;em&gt;still&lt;/em&gt; found nothing in the &lt;span class="caps"&gt;DHCP&lt;/span&gt; logs from
that printer. I emailed mom and asked her to power-cycle it a few
times&amp;#8230; still nothing! It wasn&amp;#8217;t even requesting &lt;span class="caps"&gt;DHCP&lt;/span&gt; when rolled, let
alone at a regular&amp;nbsp;interval!&lt;/p&gt;
&lt;p&gt;Fast forward a week or so, to today. I&amp;#8217;m ready to call Brother Support,
as my mother hasn&amp;#8217;t had use of her new printer in a week and a half. I&amp;#8217;m
infuriated - I&amp;#8217;ve rolled the printer dozens of times, and not a single
event in the &lt;span class="caps"&gt;DHCP&lt;/span&gt; log. I know it&amp;#8217;s sending traffic from the port - I&amp;#8217;ve
reset the counters and they&amp;#8217;re changing. I tried moving it back to the
original &lt;span class="caps"&gt;VLAN&lt;/span&gt; and confirmed that it still has its&amp;#8217; original &lt;span class="caps"&gt;IP&lt;/span&gt;. I could
get into the web interface via &lt;a href="http://lynx.isc.org/"&gt;lynx&lt;/a&gt; and *tell
it* to refresh &lt;span class="caps"&gt;DHCP&lt;/span&gt;, but this seemed quite pointless - there&amp;#8217;s no way
it&amp;#8217;s physically possible to send the web request and then switch the
port to the new &lt;span class="caps"&gt;VLAN&lt;/span&gt; before it gets&amp;nbsp;&lt;span class="caps"&gt;DHCP&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;So, I&amp;#8217;m ready to call Brother Support. I then notice that the printer is
turned off at the moment. From the switch log, it looks as though it&amp;#8217;s
been powered off for six days. So, I turn it on. And then go about
starting my prep for the Brother call, first opening up a tail on the
&lt;span class="caps"&gt;DHCP&lt;/span&gt; server log, grepped for the proper interface. And, wouldn&amp;#8217;t you
know, as I get up to let the dog out, the printer starts spitting out&amp;nbsp;pages!&lt;/p&gt;
&lt;p&gt;As far as I can tell, there&amp;#8217;s something &lt;em&gt;seriously wrong&lt;/em&gt; with the
Brother &lt;span class="caps"&gt;HL&lt;/span&gt;-2170W &lt;span class="caps"&gt;DHCP&lt;/span&gt; implementation. Specifically, it didn&amp;#8217;t get an
address on the new &lt;span class="caps"&gt;VLAN&lt;/span&gt; until it was powered off for a *long* time.
Even reboots wouldn&amp;#8217;t trigger a request, until the box had been powered
off for &lt;em&gt;days&lt;/em&gt;. More importantly, though, it seems that it only gets
&lt;span class="caps"&gt;DHCP&lt;/span&gt; &lt;strong&gt;&lt;em&gt;once&lt;/em&gt;&lt;/strong&gt; when it boots, and totally disregards the lease&amp;nbsp;time!&lt;/p&gt;</content><category term="dhcp"></category><category term="hl2170w"></category><category term="printer"></category><category term="vlan"></category></entry></feed>