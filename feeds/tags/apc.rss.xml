<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Jason Antman's Blog</title><link>http://newblog.jasonantman.com/</link><description></description><atom:link href="http://newblog.jasonantman.com/feeds/tags/apc.rss.xml" rel="self"></atom:link><lastBuildDate>Sat, 27 Jun 2009 01:03:00 -0400</lastBuildDate><item><title>Daily Work - Nagios SNMP traps, Vyatta, JasonAntman.com upgrades</title><link>http://newblog.jasonantman.com/2009/06/daily-work-nagios-snmp-traps-vyatta-jasonantmancom-upgrades/</link><description>&lt;p&gt;So it&amp;#8217;s been a very busy day. I was up until 5 &lt;span class="caps"&gt;AM&lt;/span&gt; or so working on
implementing &lt;a href="http://reductivelabs.com/trac/puppet/"&gt;Puppet&lt;/a&gt; at home.
I&amp;#8217;m building two new boxes - a storage (centralized home
directory)/syslog (to MySQL) server and a second web server (possibly
also to handle Nagios) - and I decided that they&amp;#8217;ll be totally built by
Puppet. The only thing I had to give up on was setting up the &lt;span class="caps"&gt;NFS&lt;/span&gt; share
for my home directory on the new storage box and installing and testing
&lt;a href="http://www.rsyslog.com/"&gt;rsyslog&lt;/a&gt; on&amp;nbsp;it.&lt;/p&gt;
&lt;p&gt;This afternoon around 7, I started on my weekend projects for &lt;a href="http://www.midlandparkambulance.com"&gt;the
ambulance corps&lt;/a&gt; - setting up
&lt;a href="http://www.nagios.org"&gt;Nagios&lt;/a&gt; to receive &lt;span class="caps"&gt;SNMP&lt;/span&gt; traps from the &lt;span class="caps"&gt;APC&lt;/span&gt; &lt;span class="caps"&gt;UPS&lt;/span&gt;
and moving over to the new &lt;a href="http://www.vyatta.org"&gt;Vyatta&lt;/a&gt;-based router
(from &lt;a href="http://m0n0.ch/wall/"&gt;m0n0wall&lt;/a&gt;). I&amp;#8217;d attempted the router
before, but had to rollback - I&amp;#8217;m using an old
&lt;a href="http://www.bluesocket.com/"&gt;BlueSocket&lt;/a&gt; controller for hardware - it&amp;#8217;s
just a nice black 1U enclosure with a stock Intel motherboard, &lt;span class="caps"&gt;20GB&lt;/span&gt; &lt;span class="caps"&gt;HDD&lt;/span&gt;,
&lt;span class="caps"&gt;512MB&lt;/span&gt; &lt;span class="caps"&gt;RAM&lt;/span&gt; and three 10/100 NICs. The first time, I was unable to get
link on either of the two NICs I was using, so I decided to&amp;nbsp;rollback.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Nagios &lt;span class="caps"&gt;SNMP&lt;/span&gt;&amp;nbsp;Traps&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;I found a good starting point for Nagios &lt;span class="caps"&gt;SNMP&lt;/span&gt; traps on the &lt;a href="http://altinity.blogs.com/dotorg/2006/03/lessons_in_snmp.html"&gt;OpsView
blog&lt;/a&gt;. I
setup `snmptrapd` on the Nagios server and hacked together a little
Python script to just write all of the traps to a file. After some
testing with `snmptrap` on my laptop, I did a test by pulling the
power plug of the &lt;span class="caps"&gt;UPS&lt;/span&gt;, waiting about 30 seconds, and then plugging it
back in. Sure enough, the little old &lt;a href="/2007/03/apc-ap9605-powernet-snmp-card/"&gt;&lt;span class="caps"&gt;AP9605&lt;/span&gt; PowerNet &lt;span class="caps"&gt;SNMP&lt;/span&gt;
card&lt;/a&gt;
generated two &lt;span class="caps"&gt;SNMP&lt;/span&gt; traps - one for power loss and one for power regained
- both of which showed up in the test&amp;nbsp;file&lt;/p&gt;
&lt;p&gt;The next step will be deciding how to get the traps into Nagios -
specifically whether I want to go with something heavy-weight, like
&lt;a href="http://snmptt.sourceforge.net/"&gt;SNMPtt&lt;/a&gt; that can handle other devices,
or whether I want to code a simple script myself just to deal with the
&lt;span class="caps"&gt;APC&lt;/span&gt;&amp;nbsp;cards.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Router&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;The main reason why I wanted to make the switch from m0n0 to Vyatta was
to ease the setup and maintenance of an IPsec tunnel from the ambulance
&lt;span class="caps"&gt;HQ&lt;/span&gt; to my house, so I could push backups (relatively small) over the &lt;span class="caps"&gt;WAN&lt;/span&gt;
to my infrastructure (or, rather, have Bacula pull the backups). Another
big bonus was finally having a way of configuring and checking things
through &lt;span class="caps"&gt;SSH&lt;/span&gt; without having to port-forward a web &lt;span class="caps"&gt;GUI&lt;/span&gt;. Another bonus of
having a real Linux system under the router is the ability to make
custom Nagios check scripts and easily execute them. Something I hadn&amp;#8217;t
thought of - but became obvious during the switchover - is the ability
to run full-fledged `tcpdump` on the router&amp;nbsp;itself.&lt;/p&gt;
&lt;p&gt;After building the new config myself, and confirming that the system ran
in isolation, I moved it over to production. The first issue was a bit
of a thinko on my part - the interfaces on the &lt;span class="caps"&gt;BSC&lt;/span&gt; are actually arranged
on the back of the box like eth0&amp;#8212;&amp;#8212;-eth2&amp;#8212;&amp;#8212;-eth1, so I originally had
the &lt;span class="caps"&gt;LAN&lt;/span&gt; uplink in the wrong interface. After correcting that and waiting
for the network to stabilize, I noticed a total external connectivity
failure. After some troubleshooting - thanks to tcpdump on the router -
it occurred to me that the (ancient) cable modem needs to be rebooted
when the router &lt;span class="caps"&gt;MAC&lt;/span&gt;&amp;nbsp;changes.&lt;/p&gt;
&lt;p&gt;I honestly don&amp;#8217;t remember the other problems that I ran into, but
eventually I ended up getting almost-full functionality - and then a
total network outage. A tcpdump on my laptop showed some really really
weird &lt;span class="caps"&gt;BOOTP&lt;/span&gt; traffic with addresses of 255.255.255.255. After doing some
troubleshooting and monitoring port counters on the switch, I narrowed
it down to coming from a single Windows box and the wireless access
point. After shutting off both ports, things seemed to stabilize. I also
had some &amp;#8220;martian address&amp;#8221; issues with one of the boxes, but decided to
roll the box and that solved&amp;nbsp;it.&lt;/p&gt;
&lt;p&gt;Over the next day or so, I&amp;#8217;ll be reconfiguring Nagios both at home and
at the ambulance corps to cope with the changes and add in the requisite
monitoring, and keep an eye on things. Assuming all goes well, I&amp;#8217;ll
power down the old router on&amp;nbsp;Sunday.&lt;/p&gt;
&lt;p&gt;On the home front, I&amp;#8217;ve moved over from my old storage machine to the
old one - essentially just the &lt;span class="caps"&gt;NFS&lt;/span&gt; mount, and moved over a tarball of
everything else. I also added a 1000Base-&lt;span class="caps"&gt;SX&lt;/span&gt; card to the new box, though
it appears that I&amp;#8217;m out of fiber patch cords. The old storage box was
brought down for the first time in about 3 years (aside from brief
outages for hardware upgrades or array rebuilds). Assuming I got
everything off of it, it will be relegated to the spares&amp;nbsp;pile.&lt;/p&gt;
&lt;p&gt;I&amp;#8217;m going to make a serious effort to post on a daily basis, if only for
my own future reference. I should have the demo of
&lt;a href="http://rackman.jasonantman.com"&gt;RackMan&lt;/a&gt; out soon, and I&amp;#8217;m also about
to start on integrating it with Nathan Hubbard&amp;#8217;s
&lt;a href="http://www.machdb.org/"&gt;MachDB&lt;/a&gt; as well as a &lt;span class="caps"&gt;PHP&lt;/span&gt; script I wrote to pull
port names and MACs from Cisco switches and associate them with NICs in
machines. Hopefully I&amp;#8217;ll also have some interesting Puppet stuff out&amp;nbsp;soon.&lt;/p&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">admin</dc:creator><pubDate>Sat, 27 Jun 2009 01:03:00 -0400</pubDate><guid>tag:newblog.jasonantman.com,2009-06-27:2009/06/daily-work-nagios-snmp-traps-vyatta-jasonantmancom-upgrades/</guid><category>apc</category><category>bluesocket</category><category>Nagios</category><category>snmp</category><category>vyatta</category></item><item><title>Cable Management, Power Measurements, Major Outage, Cacti</title><link>http://newblog.jasonantman.com/2008/03/cable-management-power-measurements-major-outage-cacti/</link><description>&lt;p&gt;So, once again, still really busy. But a few new&amp;nbsp;things.&lt;/p&gt;
&lt;p&gt;First, my racks both at home and at the apartment are atrocious. They
have no cable management at all. Both started with 1-3 machines, and no
real plans for upgrades (since they&amp;#8217;re just my personal/development
machines). Unfortunately, the &amp;#8220;rack&amp;#8221; (a metal workshop shelving unit) at
home now has 8 machines and a host of ancillary equipment. The one at
the apartment - an actual 42U rack - has 5 plus a few switches,
rackmount &lt;span class="caps"&gt;KMM&lt;/span&gt;, etc. They&amp;#8217;re both a jumble of wires in the back.
Unfortunately, it seems like cable management hardware is *epxensive*.
$30 for a 2U metal blank with a few plastic split D-rings, or almost $40
for a 2-meter vertical hunk of plastic channel with slits in the sides?
So, I&amp;#8217;ve been vaguely considering what it will take to fabricate some
cable management hardware of my own. Probably just building something
out of rack blanks for the horizontal off of the switches, and buying
some sort of vertical channel for power and networking/&lt;span class="caps"&gt;KVM&lt;/span&gt;. Man, those
&lt;span class="caps"&gt;KVM&lt;/span&gt; cables sure do take up a lot of space. Also at the moment, at home
my power is all coming directly out of two UPSs, whereas at the
apartment it&amp;#8217;s straight from mains off of a surge suppressor. I&amp;#8217;s like
to buy another &lt;span class="caps"&gt;UPS&lt;/span&gt; for the apartment from RefurbUPS.com, where I got the
ones from home, and also add a &lt;span class="caps"&gt;PDU&lt;/span&gt; at home and a vertical power strip at
the&amp;nbsp;apartment.&lt;/p&gt;
&lt;p&gt;Also, at the apartment, the roommates and I have had some discussion
lately about how much power the machines draw. This mainly stemmed from
our plans to move this June, into a rented house with two more people.
This seems to be falling through, so I don&amp;#8217;t have to worry about moving
and re-cabling everything, but I&amp;#8217;m still interested in finding out how
much power is being drawn. Granted, my UPSs at home give me a
more-or-less good idea of power consumption, but I&amp;#8217;d like to know in
detail. The ideal solution would be a clamp ammeter around the mains
line to the equipment - one with a serial interface. Unfortunately, I
can&amp;#8217;t seem to find such a thing, short of a digital multimeter left on
all the time. So, I guess I&amp;#8217;ll be looking around, and if I can&amp;#8217;t find
anything specific, maybe I&amp;#8217;ll work on a microcontroller that can read
1-200mV in 1mV increments, and use it with an inductive clamp ammeter
(usual output for them is 1mV per&amp;nbsp;A).&lt;/p&gt;
&lt;p&gt;So, on Monday I got into work and couldn&amp;#8217;t access my mailserver. Weird.
I never even got any Nagios alerts. I checked Nagios and&amp;#8230; nothing. As
in no connection. I &lt;span class="caps"&gt;SSH&lt;/span&gt;&amp;#8217;d home and pinged both boxes, but nothing. The
switch showed the mail server totally offline, and the Nagios box
plugged connected but &lt;span class="caps"&gt;ZERO&lt;/span&gt; data out. I reset the counters and waited.
Still nothing. After an hour or so of poking around, I determined that
both devices were on the same 6-port group on the switch, and nothing
else there was up too. So, after five long hours, I got someone back
home to switch the cables. Still nothing. On a hunch, I asked to have
her check the mail server (the &amp;#8220;new&amp;#8221; Sun Blade 150) and, sure enough, it
wasn&amp;#8217;t powered on. A click of the power button, and the mail server was
back online. Along with an ominous last email from Nagios, stating that
the &lt;span class="caps"&gt;UPS&lt;/span&gt; running my switch lost power, and 6 minutes later, was going
down hard. Then&amp;nbsp;quiet.&lt;/p&gt;
&lt;p&gt;I don&amp;#8217;t usually have power outages. So I&amp;#8217;ll admit, when I added some of
the new machines, I committed a high sin - I &amp;#8220;never got around&amp;#8221; to
setting up everything power-wise. I also have the switch running off of
an old BackUPS &lt;span class="caps"&gt;500VA&lt;/span&gt; unit, &lt;span class="caps"&gt;USB&lt;/span&gt;, without automatic self-tests. As a
result of all&amp;nbsp;this:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;The little &lt;span class="caps"&gt;UPS&lt;/span&gt; powering the switch only held out for 6-7 minutes. As
    a result, once that died, the bigger units didn&amp;#8217;t even matter, as
    all hope was lost. This needs to be on a bigger &lt;span class="caps"&gt;UPS&lt;/span&gt; - maybe one of
    the &lt;span class="caps"&gt;1000VA&lt;/span&gt;&amp;#8217;s until it gets its&amp;#8217;&amp;nbsp;own.&lt;/li&gt;
&lt;li&gt;APCupsd requires a network to initiate shutdown, so the rest of the
    machines came down hard (as confirmed by looking through log&amp;nbsp;files).&lt;/li&gt;
&lt;li&gt;The SunBlade was never setup to power on after power interruption,
    so it just sat there like a&amp;nbsp;brick.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Most disturbingly, while my Nagios/monitoring box is up (according to
the switch, power draw figures from the &lt;span class="caps"&gt;UPS&lt;/span&gt;, and the lights, as
confirmed by someone on-site), it&amp;#8217;s dead. No ping, nothing out. I&amp;#8217;ll
have to look into it, but it made me realize that this really is my only
way of analyzing problems. That needs to&amp;nbsp;stop.&lt;/p&gt;
&lt;p&gt;Maybe one day I&amp;#8217;ll have the money for a nice &lt;a href="http://www.apc.com/products/family/index.cfm?id=223"&gt;SmartUPS
&lt;span class="caps"&gt;RT&lt;/span&gt;&lt;/a&gt; or even a
&lt;a href="http://www.apc.com/products/family/index.cfm?id=189"&gt;Symmetra&lt;/a&gt; - though
getting 208V into my basement is even more of a dream than spending
$4000 on a&amp;nbsp;&lt;span class="caps"&gt;UPS&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;Also, I decided (after all this) to setup graphing of &lt;span class="caps"&gt;UPS&lt;/span&gt; data (load,
voltage in and out, temp, capacity, run time, etc.). While I haven&amp;#8217;t
gotten around to setting up &lt;a href="http://www.zenoss.com/"&gt;Zenoss&lt;/a&gt; yet, I did
a quick (well, 4 hours later I&amp;#8217;m done configuring it)
&lt;a href="http://www.cacti.net/"&gt;Cacti&lt;/a&gt;installation on my web server (I should
already have it running on the monitoring box, but who knows what that
will look like when I get&amp;nbsp;home).&lt;/p&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">admin</dc:creator><pubDate>Thu, 06 Mar 2008 01:02:00 -0500</pubDate><guid>tag:newblog.jasonantman.com,2008-03-06:2008/03/cable-management-power-measurements-major-outage-cacti/</guid><category>apc</category><category>cable management</category><category>cacti</category><category>disaster</category><category>monitoring</category><category>power distribution</category><category>power failure</category><category>rack</category><category>UPS</category></item><item><title>APC AP9605 PowerNet SNMP Card</title><link>http://newblog.jasonantman.com/2007/03/apc-ap9605-powernet-snmp-card/</link><description>&lt;p&gt;In the theme of upgrades, I also purchased two &lt;span class="caps"&gt;APC&lt;/span&gt; SmartUPS1000 units
from refurbUPS.com. Now, I know that a lot of people are perfectly happy
with serial connectivity. And it has its positives. But I&amp;#8217;m running 2-3
servers per &lt;span class="caps"&gt;UPS&lt;/span&gt;, older servers, wanted to be able to monitor the UPSs,
and perhaps control server shutdown, over the network.. So, I found that
refurbUPS.com also sells &lt;span class="caps"&gt;SNMP&lt;/span&gt; management cards for them. They sell a
refurbished &lt;span class="caps"&gt;AP9605&lt;/span&gt; - it&amp;#8217;s an old 10BaseT PowerNet &lt;span class="caps"&gt;SNMP&lt;/span&gt;-only card (with
telnet management). Seemed good, and the price of $15 was&amp;nbsp;right.&lt;/p&gt;
&lt;p&gt;They showed up, but I couldn&amp;#8217;t find much about them online, let alone
anything&amp;nbsp;useful.&lt;/p&gt;
&lt;p&gt;After a phone call to &lt;span class="caps"&gt;APC&lt;/span&gt;, I managed to get the user&amp;#8217;s manual emailed to
me. The few instructions I found online were totally&amp;nbsp;wrong.&lt;/p&gt;
&lt;p&gt;The general setup goes like&amp;nbsp;this:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Connect network cable to&amp;nbsp;card.&lt;/li&gt;
&lt;li&gt;Connect serial cable between a computer and the &lt;span class="caps"&gt;UPS&lt;/span&gt;&amp;#8217;s serial&amp;nbsp;port.&lt;/li&gt;
&lt;li&gt;Get a terminal emulator, like
    &lt;a href="http://alioth.debian.org/projects/minicom"&gt;minicom&lt;/a&gt;. Speed is&amp;nbsp;2400bps.&lt;/li&gt;
&lt;li&gt;connect and press enter. You&amp;#8217;ll be asked for a username and
    password. Use &amp;#8220;apc&amp;#8221; for&amp;nbsp;both.&lt;/li&gt;
&lt;li&gt;5) Setup the network - &lt;span class="caps"&gt;IP&lt;/span&gt;, mask, gateway,&amp;nbsp;etc.&lt;/li&gt;
&lt;li&gt;Ready-to-go!&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;I also have some information about the card on my wiki at:
&lt;a href="http://wiki.jasonantman.com/index.php/AP9605"&gt;&lt;span class="caps"&gt;AP9605&lt;/span&gt;&lt;/a&gt;.&lt;/p&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">admin</dc:creator><pubDate>Thu, 01 Mar 2007 17:09:00 -0500</pubDate><guid>tag:newblog.jasonantman.com,2007-03-01:2007/03/apc-ap9605-powernet-snmp-card/</guid><category>ap9605</category><category>apc</category><category>powernet</category><category>snmp</category><category>UPS</category></item></channel></rss>