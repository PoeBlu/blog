<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:og="http://ogp.me/ns#"
      xmlns:fb="https://www.facebook.com/2008/fbml">
<head>
    <title>Environment Variable Substitution in Apache httpd Configs</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Open Graph tags -->

    <!-- Bootstrap -->
        <link rel="stylesheet" href="http://blog.jasonantman.com/theme/css/bootstrap.flatly.min.css" type="text/css"/>
    <link href="http://blog.jasonantman.com/theme/css/font-awesome.min.css" rel="stylesheet">
    <link href="http://blog.jasonantman.com/theme/css/pygments.css" rel="stylesheet">
        <link href="http://blog.jasonantman.com/theme/css/typogrify.css" rel="stylesheet">
    <link rel="stylesheet" href="http://blog.jasonantman.com/theme/css/style.css" type="text/css"/>
    <!-- JavaScript plugins (requires jQuery) -->
    <script src="http://code.jquery.com/jquery.js"></script>

    <link rel="stylesheet" href="http://blog.jasonantman.com/theme/css/forkongithub.min.css" type="text/css" />

        <link href="http://blog.jasonantman.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Jason Antman's Blog ATOM Feed"/>
        <link href="http://blog.jasonantman.com/feeds/all.rss.xml" type="application/atom+xml" rel="alternate"
              title="Jason Antman's Blog RSS Feed"/>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-2718127-2', 'jasonantman.com');
  ga('send', 'pageview');

</script>
</head>
<body>
<span id="forkongithub"><a href="https://github.com/jantman/blog">Fork me on GitHub</a></span><nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://blog.jasonantman.com" class="navbar-brand">Jason Antman's Blog</a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="http://blog.jasonantman.com/pages/about.html">
                             About
                          </a></li>
                        <li >
                            <a href="http://blog.jasonantman.com/categories/ideas-and-rants/index.html">Ideas and rants</a>
                        </li>
                        <li >
                            <a href="http://blog.jasonantman.com/categories/miscellaneous/index.html">Miscellaneous</a>
                        </li>
                        <li >
                            <a href="http://blog.jasonantman.com/categories/monitoring/index.html">Monitoring</a>
                        </li>
                        <li >
                            <a href="http://blog.jasonantman.com/categories/ops/index.html">Ops</a>
                        </li>
                        <li >
                            <a href="http://blog.jasonantman.com/categories/projects/index.html">Projects</a>
                        </li>
                        <li >
                            <a href="http://blog.jasonantman.com/categories/puppet/index.html">Puppet</a>
                        </li>
                        <li class="active">
                            <a href="http://blog.jasonantman.com/categories/tech-howtos/index.html">Tech howtos</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a href="http://blog.jasonantman.com/archives.html"><i class="icon-th-list"></i>Archives</a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</nav>
<!-- /.navbar -->
<div class="container">
    <div class="row">
        <div class="col-lg-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="http://blog.jasonantman.com/2013/05/environment-variable-substitution-in-apache-httpd-configs/"
                       rel="bookmark"
                       title="Permalink to Environment Variable Substitution in Apache httpd Configs">
                        Environment Variable Substitution in Apache httpd&nbsp;Configs
                    </a>
                </h1>
<a href="http://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="j_antman">Tweet</a><script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="icon-calendar"></i>Sat 11 May 2013
    </span>



<span class="label label-default">Tags</span>
	<a href="http://blog.jasonantman.com/tags/apache/index.html">apache</a>
        /
	<a href="http://blog.jasonantman.com/tags/environment/index.html">environment</a>
        /
	<a href="http://blog.jasonantman.com/tags/httpd/index.html">httpd</a>
        /
	<a href="http://blog.jasonantman.com/tags/variable/index.html">variable</a>
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>I&#8217;ve been configuring Apache httpd for over a decade, from a single
personal web server to web farms running thousands of vhosts. In most of
the &#8220;real&#8221; environments I&#8217;ve worked in, we&#8217;ve had some variation of
production, stage/test/<span class="caps">QA</span> and development hosts; and usually some method
of managing configurations between them, whether it&#8217;s source control or
generating them from template. And in all of these environments, there
has invariably been drift between the configurations in the various
environments, whether it&#8217;s because of poor tools to maintain a unified
configuration or many of those emergency redirect requests that make it
into production but are never backported. This is made all the worse
because everywhere I&#8217;ve worked, the real difference between what
production and other environments <em>should</em> be is really just a string
replacement in Apache configurations - <code>/prod/</code> to <code>/test/</code> or
<code>www.example.com</code> to <code>www.dev.example.com</code> or something along those&nbsp;lines.</p>
<p>Well a few days ago I was having a discussion with some co-workers that
dovetailed into this topic, and when I started some research, I found
(<em>finally after using httpd for years</em>) that the <a href="http://httpd.apache.org/docs/2.2/configuring.html#syntax">Apache httpd 2.2
configuration file syntax
documentation</a>
states that httpd supports environment variable interpolation anywhere
in the config files (and <a href="http://httpd.apache.org/docs/2.4/configuring.html#syntax">httpd
2.4</a> supports
it with Defines as&nbsp;well).</p>
<p>Yup, that&#8217;s right. All those different Apache configs I&#8217;ve worked with
for years that define separate vhosts, document roots, rewrite targets,
ServerAliases, etc. for <code>www.example.com</code> and <code>www.qa.example.com</code> and
<code>www.dev.example.com</code> really only had to be
<code>www.${ENV_URL_PART}example.com</code>, and set <code>ENV_URL_PART</code> in the init
script or sysconfig file. (Of course this all assumes that you have your
different environments served by different httpd instances, which you
do, of&nbsp;course&#8230;)</p>
<p>For me, this is a very big deal. It means that finally, instead of
maintaining separate sets of configs for different environments which
are (theoretically, except for those emergencies) kept identical by
hand, or updating templates and then re-generating each environment&#8217;s
configs, we can finally follow the same
commit/merge/promotion-between-environments workflow that we use for
other production code and Puppet configuration. It also means that those
pesky little rewrites and other minor tweaks will make it all the way
back to development&nbsp;environments.</p>
<p>So, here&#8217;s a little example of how this would work in reality. Let&#8217;s
assume that we have 3 main environments, <code>prod</code>, <code>qa</code> and <code>dev</code> (though
this should work for N environments) and that domains are prefixed with
&#8220;qa.&#8221; or &#8220;dev.&#8221; for the respective internal environments. We set
environment variables before httpd is started, on a per-host basis,
depending on what environment that host is in. On RedHat based systems,
we&#8217;d add the variables to <code>/etc/sysconfig/httpd</code> for&nbsp;production:</p>
<div class="codehilite"><pre><span class="nb">export </span><span class="nv">HTTPD_ENV_NAME</span><span class="o">=</span><span class="s2">&quot;prod&quot;</span>
<span class="nb">export </span><span class="nv">HTTPD_ENV_URL_PART</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
</pre></div>


<p>or for&nbsp;<span class="caps">QA</span>:</p>
<div class="codehilite"><pre><span class="nb">export </span><span class="nv">HTTPD_ENV_NAME</span><span class="o">=</span><span class="s2">&quot;qa&quot;</span>
<span class="nb">export </span><span class="nv">HTTPD_ENV_URL_PART</span><span class="o">=</span><span class="s2">&quot;qa.&quot;</span>
</pre></div>


<p>Those variables will now be available to httpd within the configurations
(and also to any applications or scripts that have access to the web
server&#8217;s environment&nbsp;variables).</p>
<p>Now let&#8217;s look at an example vhost configuration file that uses the
environment&nbsp;variables:</p>
<div class="codehilite"><pre><span class="nb">ServerName</span> example.com
<span class="nb">ServerAlias</span> www.example.com
<span class="c"># Aliases including proper environment name</span>
<span class="nb">ServerAlias</span> www.${HTTPD_ENV_NAME}.example.com ${HTTPD_ENV_NAME}.example.com

<span class="nb">ErrorLog</span> <span class="sx">/var/log/httpd/example.com-error_log</span>
<span class="nb">CustomLog</span> <span class="sx">/var/log/httpd/example.com-access_log</span> combined

<span class="nb">DocumentRoot</span> <span class="sx">/sites/example.com/</span>${HTTPD_ENV_NAME}/

<span class="c"># Environment-specific configuration, if we absolutely need it:</span>
<span class="nb">Include</span> <span class="sx">/etc/httpd/sites/</span>${HTTPD_ENV_NAME}/env.conf


<span class="nb">RewriteEngine</span> <span class="k">on</span>
<span class="nb">RewriteRule</span> <span class="sx">/foobar/.</span>* http://www.${HTTPD_ENV_URL_PART}example.com/baz/ [R=302,L]
</pre></div>


<p>Every instance of <code>${HTTPD_ENV_NAME}</code> will be replaced with the value
set in the sysconfig file, and likewise with every instance of
<code>${HTTPD_ENV_URL_PART}</code>. This way, we can have one set of configurations
and use our normal source control branch/promotion process to both test
and promote changes through the environments along with application
code, and ensure that any straight-to-production emergency changes
(everyone has customer-ordered rewrites like that, right?) make it back
to development and&nbsp;qa.</p>
<p>One caveat is that, if the environment variable is not defined, the
<code>${VAR_NAME}</code> will be left as a literal string in the configuration
file. There doesn&#8217;t seem to be any way to protect against this in httpd
2.2, other than making sure the variables are set before the server
starts (and maybe setting logical default values, like an empty string,
in your init script which should be overridden by the sysconfig&nbsp;file).</p>
<p>If you&#8217;re running httpd 2.4+, you can turn on
<a href="http://httpd.apache.org/docs/2.4/mod/mod_info.html">mod_info</a> and
browse to <code>http://servername/server-info?config</code> to dump the current
configuration, which will show the variable&nbsp;substitution.</p>
            </div>
            <!-- /.entry-content -->
    <hr />
    <section class="comments" id="comments">
        <h2>Comments</h2>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'jantman'; // required: replace example with your forum shortname
            var disqus_identifier = 'environment-variable-substitution-in-apache-httpd-configs';
            var disqus_url = 'http://blog.jasonantman.com/2013/05/environment-variable-substitution-in-apache-httpd-configs/';

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-lg-3 well well-sm" id="sidebar">

<aside>
    <section>
        <ul class="list-group list-group-flush">

                <li class="list-group-item"><h4><i class="icon-home icon-large"></i>Recent Posts</h4></li>
                        <li class="list-group-item">
                            <a href="http://blog.jasonantman.com/2016/10/yesterdays-widespread-internet-outage-for-non-geeks/">
                                Yesterday&#8217;s Widespread Internet Outage, for&nbsp;non-geeks
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="http://blog.jasonantman.com/2016/08/openssh-changing-hostnames-based-on-location/">
                                OpenSSH changing hostnames based on&nbsp;location
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="http://blog.jasonantman.com/2016/08/the-psychological-side-of-remote-work/">
                                The Psychological Side of Remote&nbsp;Work
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="http://blog.jasonantman.com/2016/08/tooling-for-aws-webhooks-to-sqs-via-api-gateway-and-lambda/">
                                Tooling for <span class="caps">AWS</span> - webhooks to <span class="caps">SQS</span> via <span class="caps">API</span> Gateway and&nbsp;Lambda
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="http://blog.jasonantman.com/2016/06/a-short-comment-on-gun-rights-in-america/">
                                A Short Comment on Gun Rights in&nbsp;America
                            </a>
                        </li>


                <li class="list-group-item"><a href="http://blog.jasonantman.com/tags.html"><h4><i class="icon-tags icon-large"></i>Tags</h4></a></li>
                <li class="list-group-item">
                        <span class="tag-1">
                            <a href="http://blog.jasonantman.com/tags/puppet/index.html">
                                puppet
                            </a>
                        </span>
                        <span class="tag-1">
                            <a href="http://blog.jasonantman.com/tags/nagios/index.html">
                                Nagios
                            </a>
                        </span>
                        <span class="tag-1">
                            <a href="http://blog.jasonantman.com/tags/wordpress/index.html">
                                wordpress
                            </a>
                        </span>
                        <span class="tag-1">
                            <a href="http://blog.jasonantman.com/tags/sun/index.html">
                                sun
                            </a>
                        </span>
                        <span class="tag-1">
                            <a href="http://blog.jasonantman.com/tags/blog/index.html">
                                blog
                            </a>
                        </span>
                        <span class="tag-1">
                            <a href="http://blog.jasonantman.com/tags/security/index.html">
                                security
                            </a>
                        </span>
                        <span class="tag-1">
                            <a href="http://blog.jasonantman.com/tags/microsoft/index.html">
                                microsoft
                            </a>
                        </span>
                        <span class="tag-1">
                            <a href="http://blog.jasonantman.com/tags/sysadmin/index.html">
                                sysadmin
                            </a>
                        </span>
                        <span class="tag-1">
                            <a href="http://blog.jasonantman.com/tags/google/index.html">
                                google
                            </a>
                        </span>
                        <span class="tag-1">
                            <a href="http://blog.jasonantman.com/tags/monitoring/index.html">
                                monitoring
                            </a>
                        </span>
                        <span class="tag-1">
                            <a href="http://blog.jasonantman.com/tags/android/index.html">
                                android
                            </a>
                        </span>
                        <span class="tag-1">
                            <a href="http://blog.jasonantman.com/tags/php/index.html">
                                PHP
                            </a>
                        </span>
                        <span class="tag-1">
                            <a href="http://blog.jasonantman.com/tags/linux/index.html">
                                linux
                            </a>
                        </span>
                        <span class="tag-1">
                            <a href="http://blog.jasonantman.com/tags/python/index.html">
                                python
                            </a>
                        </span>
                        <span class="tag-2">
                            <a href="http://blog.jasonantman.com/tags/rpm/index.html">
                                rpm
                            </a>
                        </span>
                        <span class="tag-2">
                            <a href="http://blog.jasonantman.com/tags/droid/index.html">
                                droid
                            </a>
                        </span>
                        <span class="tag-2">
                            <a href="http://blog.jasonantman.com/tags/dns/index.html">
                                DNS
                            </a>
                        </span>
                        <span class="tag-2">
                            <a href="http://blog.jasonantman.com/tags/syslog/index.html">
                                syslog
                            </a>
                        </span>
                        <span class="tag-2">
                            <a href="http://blog.jasonantman.com/tags/apache/index.html">
                                apache
                            </a>
                        </span>
                        <span class="tag-2">
                            <a href="http://blog.jasonantman.com/tags/firefox/index.html">
                                firefox
                            </a>
                        </span>
                </li>
        </ul>
    </section>
    <section>
    <ul class="list-group list-group-flush">
    <li class="list-group-item" style="padding: 10px 15px 0px 15px;"><h4><i class="icon-twitter
    icon-large"></i>Twitter <a href="https://twitter.com/j_antman"
    class="twitter-follow-button" data-show-count="false"
    data-dnt="true">Follow @j_antman</a></h4>
<script>!function(d,s,id){var
  js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document,
  'script', 'twitter-wjs');</script></li>
    </ul>
    <a class="twitter-timeline" data-dnt="true"
    href="https://twitter.com/j_antman"
    data-chrome="transparent noheader" data-widget-id="429640274453594113">Tweets by @j_antman</a>
    <script>!function(d,s,id){var
    js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
    </section>
    <section>
    <ul class="list-group list-group-flush">
    <li class="list-group-item"><h4><i class="icon-github icon-large"></i>GitHub Repos</h4></li>
        <div id="gh_repos">
            <p class="list-group-item">Status updating...</p>
        </div>
            <a href="https://github.com/jantman">@jantman</a> on GitHub
    </ul>
        <script type="text/javascript">
            $(document).ready(function () {
                if (!window.jXHR) {
                    var jxhr = document.createElement('script');
                    jxhr.type = 'text/javascript';
                    jxhr.src = 'http://blog.jasonantman.com/theme/js/jXHR.js';
                    var s = document.getElementsByTagName('script')[0];
                    s.parentNode.insertBefore(jxhr, s);
                }

                github.showRepos({
                    user: 'jantman',
                    count: 5,
                    skip_forks: false,
                    target: '#gh_repos'
                });
            });
        </script>
        <script src="http://blog.jasonantman.com/theme/js/github.js" type="text/javascript"></script>
    </section>
</aside>        </div>
    </div>
</div>
<footer>
    <div class="container">
        <hr>
        <p class="pull-right"><i class="icon-arrow-up"></i> <a href="#">Back to top</a></p>


        <p>&copy; 2016 Jason Antman &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a></p>
    </div>
</footer>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="http://blog.jasonantman.com/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="http://blog.jasonantman.com/theme/js/respond.min.js"></script>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'jantman'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>


</body>
</html>